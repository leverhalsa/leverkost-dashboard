<!DOCTYPE html>
<html lang="sv">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Leverv√§nlig Kost Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #3b82f6;
            --primary-blue-dark: #2563eb;
            --sidebar-bg: #1e293b;
            --background: #f1f5f9;
            --card-bg: #ffffff;
            --text-dark: #1e293b;
            --text-light: #f8fafc;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --green: #10b981;
            --red: #ef4444;
            --yellow: #f59e0b;
            --light-red: #fef2f2;
            /* Ljus f√§rg f√∂r varning */
            --deep-red: #b91c1c;
            /* M√∂rkare r√∂tt f√∂r kant */
            --water-blue: #38bdf8;
            --activity-color: #f59e0b;
            /* Gul/Orange f√∂r aktivitet */
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background: var(--background);
            color: var(--text-dark);
            display: flex;
            min-height: 100vh;
        }

        /* Sidomeny */
        .sidebar {
            width: 250px;
            background: var(--sidebar-bg);
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
            gap: 20px;
            /* L√§gg till mellanrum mellan navigering och kalender */
        }

        .sidebar h1 {
            margin: 0;
            font-size: 1.6rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar nav a {
            color: #cbd5e1;
            text-decoration: none;
            padding: 14px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
            transition: background 0.2s, color 0.2s;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: var(--primary-blue);
            color: var(--text-light);
        }

        /* L√•s knapp i sidomenyn */
        .btn-lock {
            background: #f59e0b;
            color: white;
            padding: 10px;
            margin-top: auto;
            /* Trycker ner knappen i botten */
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-lock:hover {
            background: #d97706;
        }

        .unlocked {
            background: var(--green);
        }

        .unlocked:hover {
            background: var(--green-dark);
        }

        /* Huvudinneh√•ll */
        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .card {
            background: var(--card-bg);
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
            transition: border 0.3s;
        }

        h2 {
            margin-top: 0;
            margin-bottom: 20px;
            font-size: 1.5rem;
            color: var(--text-dark);
        }

        /* Formul√§r & Knappar */
        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        select,
        input,
        button,
        textarea {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        select:focus,
        input:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }

        button {
            background: var(--primary-blue);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: var(--primary-blue-dark);
        }

        /* Radera knappar i tabell */
        .btn-delete {
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
        }

        /* Om appen √§r l√•st, d√∂lj radera knappen */
        .locked-feature {
            display: none !important;
        }

        .btn-delete:hover {
            background: #fee2e2;
            color: var(--red);
        }

        /* AI-knappar */
        .btn-gemini {
            background: linear-gradient(135deg, #6366f1, #a855f7);
            margin-top: 10px;
        }

        .btn-gemini:hover {
            background: linear-gradient(135deg, #4f46e5, #9333ea);
        }

        .btn-water {
            background: var(--water-blue);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            width: 30%;
        }

        .btn-water:hover {
            background: #0ea5e9;
        }

        .btn-activity {
            background: var(--activity-color);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            width: 30%;
        }

        .btn-activity:hover {
            background: #d97706;
            /* M√∂rkare orange */
        }

        .inline-goal-input {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .inline-goal-input input {
            width: 65%;
            padding: 8px;
        }

        .inline-goal-input button {
            width: 35%;
            padding: 8px;
        }

        .btn-utility {
            background: #64748b;
            color: white;
            /* Lagt till vit textf√§rg f√∂r utility-knappar */
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            /* S√§krar att den tar upp hela rutn√§tscellen */
            padding: 12px 14px;
            /* S√§krar att den ser ut som en knapp/input */
            border-radius: 8px;
            margin-top: 0;
            /* Tar bort extra marginal */
        }

        .btn-utility:hover {
            background: #475569;
        }

        .btn-import-wrapper {
            /* Flex container f√∂r importknapp och dold input */
            position: relative;
            display: inline-block;
            width: 100%;
            box-sizing: border-box;
            height: 100%;
        }

        .btn-import-label {
            /* G√∂mmer det faktiska input-f√§ltet */
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }


        /* Tabell */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border-bottom: 1px solid var(--border-color);
            padding: 14px;
            text-align: left;
            vertical-align: middle;
        }

        th {
            background: #f8fafc;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
        }

        .numeric-cell {
            text-align: right;
            /* H√∂gerjustering f√∂r siffror */
        }

        /* Visuell varning f√∂r ej leverv√§nliga m√•ltider */
        .warning-row {
            background-color: var(--light-red);
            border-left: 4px solid var(--deep-red);
        }

        .warning-row td {
            border-color: #fecaca;
        }

        /* NYTT: Stil f√∂r mobilanpassade listor */
        @media (max-width: 768px) {

            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
                width: 100%;
                /* S√§krar att element tar full bredd */
            }

            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid var(--border-color);
                margin-bottom: 10px;
                border-radius: 8px;
                overflow: hidden;
                background: var(--card-bg);
            }

            td {
                border: none;
                position: relative;
                padding-left: 50%;
                /* Skapar plats f√∂r etikett */
                text-align: right;
                font-size: 0.9rem;
            }

            td::before {
                /* Visa kolumnrubriken som etikett */
                content: attr(data-label);
                position: absolute;
                left: 14px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: 600;
                color: var(--text-dark);
            }

            /* Justera layout f√∂r sista kolumnen (Ta Bort) */
            td:last-child {
                text-align: center;
                padding-left: 0;
                background: #f8fafc;
            }

            td:last-child::before {
                content: "";
            }

            /* Justeringar f√∂r F√∂rhandsgranskning */
            #mealPreviewContent {
                white-space: normal !important;
                /* L√•t texten svepa in */
                word-break: break-word;
                /* Bryt l√•nga ord */
                line-height: 1.4;
            }
        }


        /* √ñversikt Sida */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 5px 0;
            font-size: 1rem;
            color: var(--text-secondary);
        }

        .stat-card p {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .chart-container {
            height: 350px;
        }

        /* Journal */
        #journal-entries {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .journal-entry {
            background: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid var(--primary-blue);
            scroll-margin-top: 20px;
            /* F√∂r smooth scroll */
        }

        .journal-entry small {
            color: var(--text-secondary);
            display: block;
            margin-bottom: 5px;
        }

        /* Styling f√∂r Hum√∂rv√§ljare */
        #journalMood {
            padding: 0;
            height: 30px;
            margin-top: 10px;
        }

        #journalMood+p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-top: 5px;
        }


        /* Gemini AI-svar / Feedback-ruta (Anv√§nds nu f√∂r lokal feedback) */
        .gemini-response {
            background: linear-gradient(135deg, #f5f3ff, #faf5ff);
            border: 1px solid #e9d5ff;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            color: #5b21b6;
            font-size: 0.95rem;
            line-height: 1.6;
            white-space: pre-wrap;
            /* L√•ter radbrytningar visas */
            transition: all 0.3s ease;
        }

        .gemini-response.error {
            background: #fef2f2;
            border: 1px solid var(--deep-red);
            color: var(--deep-red);
        }

        .gemini-response h3 {
            margin-top: 0;
            color: #7e22ce;
            font-size: 1.1rem;
            margin-bottom: 10px;
            border-bottom: 1px dashed #c084fc;
            padding-bottom: 5px;
        }

        .gemini-response p {
            margin-bottom: 0;
        }

        /* Laddningsmodal */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            color: white;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Kalender CSS (Flyttad till sidebar) */
        .calendar-card {
            padding: 15px;
            border-radius: 12px;
            text-align: center;
            background: #334155;
            /* M√∂rkare bakgrund i sidomenyn */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            margin: 0 0 20px 0;
            /* Marginal i sidomenyn */
            max-width: 100%;
            /* Tar upp all plats i sidomenyn */
            color: var(--text-light);
            /* Ljus text */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-header button {
            width: 30px;
            height: 30px;
            padding: 0;
            font-size: 0.8rem;
            border-radius: 6px;
            background: #475569;
            /* M√∂rkare knapp bakgrund */
            color: white;
        }

        .calendar-header button:hover {
            background: var(--primary-blue);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
            font-size: 0.85rem;
        }

        .calendar-day-name {
            font-weight: 600;
            color: #94a3b8;
            /* Ljusare text f√∂r dagar */
            padding: 5px 0;
        }

        .calendar-day {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            position: relative;
            font-weight: 500;
            padding: 5px;
            color: #f8fafc;
        }

        .calendar-day:active {
            transform: scale(0.95);
        }

        .calendar-day:hover:not(.empty):not(.selected) {
            background: #475569;
        }

        .calendar-day.empty {
            cursor: default;
            background: transparent;
        }

        .calendar-day.selected {
            background: var(--primary-blue);
            color: white;
            font-weight: 700;
            box-shadow: 0 0 0 2px var(--primary-blue-dark);
        }

        .calendar-day.logged::after {
            content: '‚óè';
            position: absolute;
            bottom: 2px;
            right: 2px;
            font-size: 9px;
            color: var(--green);
            line-height: 1;
        }

        /* Journalv√§rden layout (mer kompakt) */
        .metric-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* Responsivitet */
        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                justify-content: space-between;
                /* √Ñndrad f√∂r b√§ttre justering */
                align-items: center;
                /* Centrera vertikalt */
                padding: 10px 15px;
                /* Justerad padding */
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                position: fixed;
                /* G√∂r menyn fast i toppen */
                top: 0;
                z-index: 50;
                background: var(--sidebar-bg);
                /* L√§gg till bakgrundsf√§rg */
            }

            .sidebar h1,
            .sidebar .btn-lock {
                display: none;
                /* D√∂lj titel och l√•sknapp p√• sm√• sk√§rmar */
            }

            .sidebar nav {
                display: flex;
                flex-grow: 1;
                justify-content: center;
                /* Centrera nav-l√§nkar */
            }

            .sidebar a {
                padding: 8px 12px;
                /* Justerad padding f√∂r l√§nkar */
                text-align: center;
                flex-direction: column;
                gap: 4px;
                /* Mindre gap */
                margin-bottom: 0;
                font-size: 0.75rem;
                /* N√•got mindre text */
            }

            .sidebar a span {
                /* Visa text p√• mobilen */
                display: block;
            }

            .content {
                padding: 15px;
                padding-top: 75px;
                /* Justerad padding f√∂r fast meny */
            }

            .calendar-card {
                display: none !important;
                /* D√∂lj kalendern p√• mobilen */
            }

            .metric-grid,
            .overview-grid {
                grid-template-columns: 1fr;
            }

            .overview-grid {
                gap: 15px;
            }
        }
    </style>
</head>

<body>
    <!-- Sidomeny -->
    <aside class="sidebar">
        <h1>üåø Leverkost</h1> <!-- √Ñndrad fr√•n üçé till üåø -->

        <!-- NYTT: Kalenderkort flyttas in h√§r -->
        <div class="calendar-card">
            <div class="calendar-header">
                <button onclick="changeMonth(-1)">&#9664;</button>
                <h3 id="currentMonthYear" style="margin: 0; font-size: 1.2rem; color: white;"></h3>
                <button onclick="changeMonth(1)">&#9654;</button>
            </div>
            <div class="calendar-grid" id="calendarDays">
                <div class="calendar-day-name">M√•n</div>
                <div class="calendar-day-name">Tis</div>
                <div class="calendar-day-name">Ons</div>
                <div class="calendar-day-name">Tor</div>
                <div class="calendar-day-name">Fre</div>
                <div class="calendar-day-name">L√∂r</div>
                <div class="calendar-day-name">S√∂n</div>
                <!-- Kalenderdagar fylls i h√§r av JS -->
            </div>
        </div>
        <!-- SLUT Kalenderkort -->

        <nav>
            <a href="#" class="active" onclick="showPage('meals')">ü•ó <span id="navMeals">M√•ltider</span></a>
            <a href="#" onclick="showPage('overview')">üìä <span id="navOverview">√ñversikt</span></a>
            <a href="#" onclick="showPage('journal')">üìÇ <span id="navJournal">Journal & Verktyg</span></a>
        </nav>

        <button id="lockButton" class="btn-lock" onclick="toggleLockState()">üîí L√•st</button>

    </aside>

    <!-- Huvudinneh√•ll -->
    <main class="content">
        <!-- Spr√•kv√§ljare l√§ggs till h√§r -->
        <div class="card" style="margin-bottom: 10px; padding: 10px 24px;">
            <label for="languageSelect" style="display: inline-block; margin-right: 10px;">V√§lj Spr√•k:</label>
            <select id="languageSelect" onchange="setLanguage(this.value)" style="width: auto; padding: 8px 12px;">
                <option value="sv">Svenska</option>
                <option value="en">English</option>
                <option value="es">Espa√±ol</option>
                <option value="it">Italiano</option>
            </select>
        </div>
        <!-- Slut Spr√•kv√§ljare -->

        <!-- M√•ltider Sektion -->
        <section id="meals" class="page active">

            <!-- Gammalt Kalenderkort borttaget fr√•n denna plats -->

            <div class="card">
                <h2 id="h2AddMeal">L√§gg till m√•ltid</h2>
                <!-- Datumv√§ljare (ers√§tts av kalender, beh√•lls dold f√∂r datahantering) -->
                <div class="form-group" style="display: none;">
                    <label for="mealDate">Datum:</label>
                    <input type="date" id="mealDate" />
                </div>

                <div class="form-group">
                    <label id="labelMealType" for="mealType">M√•ltid:</label>
                    <!-- M√•ltidstyper fylls i av JavaScript -->
                    <select id="mealType"></select>
                </div>
                <div class="form-group">
                    <label id="labelFoodSelect" for="foodSelect">Livsmedel:</label>
                    <!-- onchange f√∂r f√∂rhandsgranskning -->
                    <select id="foodSelect" onchange="calculateMealPreview();"></select>
                </div>

                <!-- NYTT: Portionsbaserad inmatning -->
                <div class="form-group">
                    <label id="labelAmountValue" for="amountValue">M√§ngd:</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="number" id="amountValue" value="1" min="0.1" step="0.1" style="width: 50%;"
                            oninput="calculateMealPreview();" />
                        <!-- Enheter fylls i av JavaScript -->
                        <select id="amountUnit" style="width: 50%;" onchange="calculateMealPreview();"></select>
                        <input type="hidden" id="finalGrams" value="100">
                    </div>
                </div>

                <!-- F√∂rhandsgranskning av m√•ltiden -->
                <div id="mealPreview" class="gemini-response"
                    style="display: none; border-left: 4px solid var(--primary-blue-dark); padding: 10px; margin-bottom: 10px; background: #e0f2fe; color: var(--text-dark);">
                    <h3 id="h3CalculatedIntake"
                        style="color: var(--primary-blue-dark); border-bottom: none; margin-top: 0; margin-bottom: 5px; font-size: 1rem; font-weight: 700;">
                        Ber√§knat intag:</h3>
                    <p id="mealPreviewContent" style="margin: 0;"></p>
                </div>

                <button id="buttonAddMeal" onclick="addMeal()">‚ûï L√§gg till</button>
            </div>

            <!-- NYTT: L√§gg till eget livsmedel -->
            <div id="customFoodCard" class="card locked-feature">
                <h2 id="h2AddCustomFood">ü•© L√§gg till eget livsmedel</h2>
                <div class="form-group">
                    <label for="customFoodName">Namn:</label>
                    <input type="text" id="customFoodName" placeholder="Ex: Hemlagad gr√∂n smoothie" />
                </div>
                <div class="overview-grid"
                    style="grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label for="customFoodProtein" id="labelProtein">Protein (g/100g):</label>
                        <input type="number" id="customFoodProtein" value="0" min="0" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label for="customFoodFat" id="labelFat">Fett (g/100g):</label>
                        <input type="number" id="customFoodFat" value="0" min="0" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label for="customFoodCarbs" id="labelCarbs">Kolhydrater (g/100g):</label>
                        <input type="number" id="customFoodCarbs" value="0" min="0" step="0.1" />
                    </div>
                    <div class="form-group">
                        <label for="customFoodCalories" id="labelCalories">Kalorier (kcal/100g):</label>
                        <input type="number" id="customFoodCalories" value="0" min="0" />
                    </div>
                </div>
                <div class="form-group">
                    <label id="labelLiverFriendly">Leverv√§nlig:</label>
                    <input type="checkbox" id="customFoodFriendly" checked style="width: auto; margin-top: 5px;" />
                    <span id="customFoodFriendlyDesc"
                        style="font-size: 0.9rem; margin-left: 10px; color: var(--text-secondary);">Markera om
                        livsmedlet st√∂djer leverh√§lsan.</span>
                </div>
                <button onclick="addCustomFood()" style="width: auto;" id="saveCustomFoodButton">+ Spara
                    Livsmedel</button>
            </div>
            <!-- SLUT Custom Food -->

            <!-- LOKAL FEEDBACK -->
            <div class="card">
                <h2 id="h2LiverHealthReport">üéØ Leverh√§lsorapport</h2>
                <div id="liverHealthFeedback" class="gemini-response"
                    style="display: block; background: #fffbeb; border: 1px solid #fcd34d; color: #b45309;">
                    <!-- Inneh√•ll genereras av JavaScript (updateLiverHealthFeedback) -->
                    Laddar rapport...
                </div>
            </div>
            <!-- SLUT LOKAL FEEDBACK -->

            <div class="card">
                <h2 id="h2MealsForDate">M√•ltider f√∂r <span id="mealsTitleDate">Idag</span></h2>
                <table>
                    <thead>
                        <tr>
                            <th id="thMealType">M√•ltid</th>
                            <th id="thFoodItem">Livsmedel</th>
                            <th id="thAmount">M√§ngd</th>
                            <th id="thProtein">Protein</th>
                            <th id="thFat">Fett</th>
                            <th id="thCarbs">Kolhydrater</th>
                            <th id="thCalories">Kalorier</th>
                            <th id="thLiverFriendly">Leverv√§nlig</th>
                            <th id="thDeleteMeal">Ta bort</th>
                        </tr>
                    </thead>
                    <tbody id="mealTableBody"></tbody>
                </table>
            </div>
        </section>

        <!-- √ñversikt Sektion -->
        <section id="overview" class="page">
            <!-- M√•lhantering -->
            <div class="card">
                <h2 id="h2SetDailyGoals">üèÜ S√§tt Dagliga M√•l</h2>
                <div class="overview-grid"
                    style="grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div class="form-group">
                        <label for="goalCalories" id="labelGoalCalories">Kalorier (kcal):</label>
                        <input type="number" id="goalCalories" placeholder="2000" min="500">
                    </div>
                    <div class="form-group">
                        <label for="goalProtein" id="labelGoalProtein">Protein (g):</label>
                        <input type="number" id="goalProtein" placeholder="100" min="0">
                    </div>
                    <div class="form-group">
                        <label for="goalFat" id="labelGoalFat">Fett (g):</label>
                        <input type="number" id="goalFat" placeholder="60" min="0">
                    </div>
                    <div class="form-group">
                        <label for="goalCarbs" id="labelGoalCarbs">Kolhydrater (g):</label>
                        <input type="number" id="goalCarbs" placeholder="250" min="0">
                    </div>
                </div>
                <button onclick="saveGoals()" style="width: auto; margin-top: 10px;" id="saveGoalsButton">Spara
                    M√•l</button>
            </div>

            <!-- Hydrering -->
            <div class="card">
                <h2 id="h2Hydration">üíß Hydrering</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.5rem; color: var(--water-blue);"><span id="intakeTodayText">Intag
                            idag:</span> <span id="waterIntakeDisplay">0 ml</span></h3>
                    <h3 style="margin: 0; font-size: 1.5rem; color: var(--text-secondary);"><span
                            id="waterGoalText">M√•l:</span> <span id="waterGoalDisplay">0 ml</span></h3>
                </div>
                <!-- NYTT: Inline input f√∂r att s√§tta vattenm√•l -->
                <div class="inline-goal-input">
                    <input type="number" id="waterGoalInput" placeholder="S√§tt m√•l (ml)" value="2500" min="100">
                    <button onclick="setWaterGoal()" id="setWaterGoalButton">S√§tt M√•l</button>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                    <button class="btn-water" onclick="addWater(250)">+ 250 ml</button>
                    <button class="btn-water" onclick="addWater(500)">+ 500 ml</button>
                    <button class="btn-water" onclick="addWater(-250)">- 250 ml</button>
                </div>
            </div>

            <!-- Aktivitet -->
            <div class="card">
                <h2 id="h2Activity">üèÉ‚Äç‚ôÄÔ∏è Aktivitet</h2>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="margin: 0; font-size: 1.5rem; color: var(--activity-color);"><span
                            id="trainingTodayText">Tr√§ning idag:</span> <span id="activityMinutesDisplay">0 min</span>
                    </h3>
                    <h3 style="margin: 0; font-size: 1.5rem; color: var(--text-secondary);"><span
                            id="activityGoalText">M√•l:</span> <span id="activityGoalDisplay">0 min</span></h3>
                </div>
                <!-- NYTT: Inline input f√∂r att s√§tta aktivitetsm√•l -->
                <div class="inline-goal-input">
                    <input type="number" id="activityGoalInput" placeholder="S√§tt m√•l (min)" value="30" min="1">
                    <button onclick="setActivityGoal()" id="setActivityGoalButton">S√§tt M√•l</button>
                </div>
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                    <button class="btn-activity" onclick="addActivity(15)">+ 15 min</button>
                    <button class="btn-activity" onclick="addActivity(30)">+ 30 min</button>
                    <button class="btn-activity" onclick="addActivity(-15)">- 15 min</button>
                </div>
            </div>

            <div class="overview-grid">
                <div class="stat-card">
                    <h3 id="h3TotalProtein">Totalt Protein</h3>
                    <p id="totalProtein">0 g</p>
                </div>
                <div class="stat-card">
                    <h3 id="h3TotalFat">Totalt Fett</h3>
                    <p id="totalFat">0 g</p>
                </div>
                <div class="stat-card">
                    <h3 id="h3TotalCarbs">Totala Kolhydrater</h3>
                    <p id="totalCarbs">0 g</p>
                </div>
                <div class="stat-card">
                    <h3 id="h3TotalCalories">Totala Kalorier</h3>
                    <p id="totalCalories">0 kcal</p>
                </div>
            </div>

            <!-- M√•l√∂versiktsdiagram -->
            <div class="card">
                <h2 id="h2DailyGoalStatus">Daglig M√•lstatus</h2>
                <p class="text-secondary" id="pDailyGoalStatusDesc">J√§mf√∂r din dagliga prestation mot dina satta m√•l.
                </p>
                <div class="chart-container">
                    <canvas id="goalStatusChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2 id="h2CalDistributionMacro">Kalorif√∂rdelning fr√•n makronutrienter</h2>
                <div class="chart-container">
                    <canvas id="nutritionChart"></canvas>
                </div>
            </div>
            <div class="card">
                <h2 id="h2CalDistributionLiver">Kalorif√∂rdelning: Leverv√§nlig vs. Ej leverv√§nlig</h2>
                <div class="chart-container">
                    <canvas id="liverFriendlyChart"></canvas>
                </div>
            </div>
            <!-- Trenddiagram -->
            <div class="card">
                <h2 id="h2CalorieTrend">Kaloritrend (Sista 7 dagarna)</h2>
                <p class="text-secondary" id="pCalorieTrendDesc">Visar det totala dagliga kaloriintaget baserat p√•
                    loggade m√•ltider, j√§mf√∂rt med ditt m√•l.</p>
                <div class="chart-container">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
            <!-- Aktivitetstrenddiagram -->
            <div class="card">
                <h2 id="h2ActivityTrend">Aktivitetstrend (Sista 7 dagarna)</h2>
                <p class="text-secondary" id="pActivityTrendDesc">Visar loggade tr√§ningsminuter de senaste 7 dagarna,
                    j√§mf√∂rt med ditt m√•l.</p>
                <div class="chart-container">
                    <canvas id="activityTrendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- Journal & Verktyg Sektion -->
        <section id="journal" class="page">
            <div class="card">
                <h2 id="h2WriteJournalEntry">Skriv en journalanteckning</h2>
                <!-- Hum√∂rv√§ljare -->
                <div class="form-group">
                    <label for="journalMood" id="labelMood">Hum√∂r idag (1=D√•ligt, 5=Toppen):</label>
                    <input type="range" id="journalMood" min="1" max="5" value="3" list="mood-markers">
                    <datalist id="mood-markers">
                        <option value="1" label="1">
                        <option value="2" label="2">
                        <option value="3" label="3">
                        <option value="4" label="4">
                        <option value="5" label="5">
                    </datalist>
                    <p class="text-secondary mt-2"><span id="moodValueText">Valt hum√∂r:</span> <span
                            id="currentMoodValue">3</span></p>
                </div>
                <div class="form-group">
                    <label for="journalText" id="labelHowAreYou">Hur m√•r du idag?</label>
                    <textarea id="journalText" rows="5"
                        placeholder="Beskriv dina symptom, din energi, eller andra tankar..."></textarea>
                </div>
                <button id="saveJournalButton" onclick="saveJournalEntry()">üíæ Spara inl√§gg</button>
                <!-- AI-knapp Togs bort f√∂r att f√∂rhindra krasch: <button class="btn-gemini" onclick="getCorrelationAnalysis()">‚ú® AI Sammanfattning (Senaste dagarna)</button> -->
                <div id="correlationAnalysis" class="gemini-response" style="display: none;"></div>

            </div>

            <!-- NYTT KORT: Journalv√§rden (Leverenzymer, etc.) -->
            <div class="card">
                <h2 id="h2TrackHealthMetrics">üß™ Sp√•ra Journalv√§rden</h2>
                <div class="metric-grid">
                    <div class="form-group">
                        <label for="metricDate" id="labelDateOfTest">Datum f√∂r prov:</label>
                        <input type="date" id="metricDate" />
                    </div>
                    <div class="form-group">
                        <label for="metricName" id="labelMetricValue">V√§rde (Ex: ALAT, Kolesterol):</label>
                        <input type="text" id="metricName" placeholder="T.ex. ALAT, Bilirubin"
                            onchange="renderMetricChart()" /> <!-- Added onchange -->
                    </div>
                </div>
                <div class="metric-grid">
                    <div class="form-group">
                        <label for="metricValue" id="labelMetricResult">Resultat:</label>
                        <input type="number" id="metricValue" step="0.01" placeholder="T.ex. 0.62" />
                    </div>
                    <div class="form-group">
                        <label for="metricUnit" id="labelMetricUnit">Enhet (Ex: $\mu$mol/L):</label>
                        <input type="text" id="metricUnit" placeholder="T.ex. $\mu$mol/L, mmol/L" />
                    </div>
                </div>
                <button onclick="saveHealthMetric()" id="saveMetricButton">+ Spara V√§rde</button>
            </div>

            <!-- NYTT: Journalv√§rde Trenddiagram -->
            <div class="card">
                <h2 id="h2MetricTrend">üìâ Journalv√§rdestrender</h2>
                <p class="text-secondary" id="pMetricTrendDesc">V√§lj ett sp√•rat v√§rde ovan f√∂r att se hur det f√∂r√§ndrats
                    √∂ver tid.</p>
                <div class="chart-container">
                    <canvas id="metricTrendChart"></canvas>
                </div>
            </div>

            <div class="card">
                <h2 id="h2MyNotesAndMetrics">Mina anteckningar och V√§rden</h2>

                <!-- Tabell f√∂r Journalv√§rden -->
                <h3 id="h3LoggedMetrics" style="margin-top: 0; margin-bottom: 10px; font-size: 1.2rem;">Loggade
                    Journalv√§rden</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>V√§rde</th>
                            <th>Resultat</th>
                            <th>Enhet</th>
                            <th id="metricDeleteHeader">Ta bort</th>
                        </tr>
                    </thead>
                    <tbody id="metricTableBody">
                        <!-- Data renderas h√§r -->
                    </tbody>
                </table>

                <!-- Filtrering f√∂r Journalanteckningar -->
                <h3 id="h3JournalEntriesLog" style="margin-top: 25px; margin-bottom: 10px; font-size: 1.2rem;">
                    Journalanteckningar</h3>
                <div class="overview-grid" style="grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterMood" id="labelFilterMood">Filtrera Hum√∂r:</label>
                        <select id="filterMood" onchange="renderJournalEntries()">
                            <option value="0">Alla</option>
                            <option value="5">5 (ü§© Toppen)</option>
                            <option value="4">4 (üòÑ Bra)</option>
                            <option value="3">3 (üôÇ Neutral)</option>
                            <option value="2">2 (üòê Lite nere)</option>
                            <option value="1">1 (üòû D√•ligt)</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-bottom: 0;">
                        <label for="filterText" id="labelSearchText">S√∂k text:</label>
                        <input type="text" id="filterText" placeholder="S√∂k ord i texten..."
                            oninput="renderJournalEntries()">
                    </div>
                </div>
                <div id="journal-entries">
                    <p>Inga anteckningar √§n.</p>
                </div>
            </div>

            <!-- NYTT: Dataverktyg -->
            <div id="dataToolsCard" class="card locked-feature">
                <h2 id="h2DataTools">üõ†Ô∏è Dataverktyg</h2>
                <div class="overview-grid" style="grid-template-columns: repeat(3, 1fr); gap: 10px;">
                    <button class="btn-utility" onclick="exportData()" id="exportDataButton">‚¨áÔ∏è Exportera data</button>

                    <!-- FIXAD Import-knapp: Anv√§nder div/button/input struktur f√∂r att matcha Export-knappens utseende -->
                    <div class="btn-import-wrapper">
                        <button class="btn-utility"
                            style="position: absolute; top: 0; left: 0; height: 100%; pointer-events: none;"
                            id="importDataButton">‚¨ÜÔ∏è Importera data</button>
                        <input type="file" id="importFile" accept="application/json" onchange="importData(event)"
                            style="opacity: 0; position: absolute; top: 0; left: 0; height: 100%; width: 100%; cursor: pointer;" />
                    </div>

                    <button class="btn-delete btn-utility" style="background: var(--red); color: white;"
                        onclick="resetData()" id="resetDataButton">üóëÔ∏è Nollst√§ll all data</button>
                </div>
                <p style="margin-top: 15px; font-size: 0.85rem; color: var(--text-secondary);" id="pUtilityDesc">Anv√§nd
                    verktygen f√∂r att s√§kerhetskopiera din data eller rensa din logg.</p>
            </div>
            <!-- SLUT Dataverktyg -->
        </section>
    </main>

    <div id="loader" style="display: none;">Bearbetar...</div>

    <script>
        // Global variabel f√∂r att h√•lla det aktuella spr√•ket (standard till svenska)
        let currentLang = localStorage.getItem('appLanguage') || 'sv';

        // --- L√ÖS FUNKTIONALITET OCH VARIABLER ---
        const ADMIN_PASSWORD = "admin"; // L√§tt att komma ih√•g f√∂r demonstration. √Ñndra detta!
        let isLocked = true; // B√ñRJA L√ÖST

        function toggleLockState() {
            const T = Translations[currentLang];

            if (isLocked) {
                // F√∂rs√∂k l√•sa upp
                const password = prompt(T.prompts.unlockPassword);
                if (password === ADMIN_PASSWORD) {
                    isLocked = false;
                    alert(T.alerts.unlocked);
                } else if (password !== null) {
                    alert(T.alerts.wrongPassword);
                }
            } else {
                // L√•s igen
                isLocked = true;
                alert(T.alerts.locked);
            }
            updateLockUI();
            updateUI(); // √Öterst√§lla tabellerna och korten
        }

        function updateLockUI() {
            const T = Translations[currentLang];
            const lockButton = document.getElementById('lockButton');
            const customFoodCard = document.getElementById('customFoodCard');
            const dataToolsCard = document.getElementById('dataToolsCard');

            // Uppdatera sidomenyknappen
            if (lockButton) {
                lockButton.classList.toggle('unlocked', !isLocked);
                lockButton.innerHTML = isLocked ? `üîí ${T.buttons.locked}` : `üîì ${T.buttons.unlocked}`;
            }

            // D√∂lj/Visa kort
            if (customFoodCard) {
                customFoodCard.classList.toggle('locked-feature', isLocked);
            }
            if (dataToolsCard) {
                dataToolsCard.classList.toggle('locked-feature', isLocked);
            }

            // Uppdatera om Ta Bort-kolumnen ska visas
            const deleteHeaders = document.querySelectorAll('#meals thead th:last-child, #metricDeleteHeader');
            deleteHeaders.forEach(header => {
                header.style.display = isLocked ? 'none' : 'table-cell';
            });

        }

        // --- LOKALISERING (F√ñR ENKEL √ñVERS√ÑTTNING) ---
        const Translations = {
            sv: {
                // Generella
                appTitle: "Leverkost",
                today: "Idag",
                prompts: {
                    unlockPassword: "Ange l√∂senord f√∂r att l√•sa upp farliga funktioner:",
                    confirmReplaceData: "√Ñr du s√§ker p√• att du vill ers√§tta din nuvarande data med den importerade filen?",
                    confirmResetData: "VARNING: √Ñr du helt s√§ker p√• att du vill nollst√§lla all data? Detta kan inte √•ngras!",
                    invalidName: "V√§nligen ange ett unikt namn f√∂r livsmedlet.",
                    metricValidation: "V√§nligen fyll i datum, v√§rde, resultat och enhet."
                },
                alerts: {
                    unlocked: "Appen √§r uppl√•st!",
                    wrongPassword: "Fel l√∂senord.",
                    locked: "Appen √§r l√•st.",
                    customFoodSuccess: (name) => `Livsmedlet "${name}" har lagts till och √§r nu tillg√§ngligt i rullistan!`,
                    importError: "Fel: Filen verkar inte vara en giltig Leverkost-backupfil.",
                    jsonError: "Fel vid import: Kunde inte l√§sa filen som JSON. Kontrollera filformatet."
                },
                // NYTT: Lokaliserade feedbackmeddelanden
                feedback: {
                    welcome: "V√§lkommen!",
                    logFirstMeal: (date) => `Logga din f√∂rsta m√•ltid f√∂r att f√• en leverh√§lsorapport f√∂r ${date}.`,
                    excellent: "Utm√§rkt! ‚úÖ",
                    excellentMessage: "Ditt intag best√•r till 100% av leverv√§nliga kalorier. Forts√§tt √§ta n√§ringsrikt och undvik de processade livsmedlen!",
                    good: "Mycket Bra! üåü",
                    goodMessage: (percentage, kcal, list) => `Endast ${percentage}% av ditt kaloriintag √§r icke-leverv√§nligt. Du ligger bra till! F√∂rs√∂k att byta ut dessa: <br>${list}`,
                    warning: "Se √∂ver din kost! ‚ö†Ô∏è",
                    warningMessage: (percentage, kcal, list) => `${percentage}% av ditt intag (${kcal} kcal) kommer fr√•n livsmedel som √§r tungt f√∂r levern. Fokusera p√• att minska f√∂ljande: <br>${list}`,
                },
                buttons: {
                    locked: "L√•st",
                    unlocked: "Uppl√•st",
                    saveGoals: "Spara M√•l",
                    setGoal: "S√§tt M√•l",
                    saveEntry: "üíæ Spara inl√§gg",
                    saveMetric: "+ Spara V√§rde",
                    saveCustomFood: "+ Spara Livsmedel", // Ny dedikerad knapp
                    export: "‚¨áÔ∏è Exportera data",
                    import: "‚¨ÜÔ∏è Importera data",
                    reset: "üóëÔ∏è Nollst√§ll all data",
                },
                // NYTT: Navigation Titles
                nav: {
                    meals: "M√•ltider",
                    overview: "√ñversikt",
                    journal: "Journal & Verktyg"
                },
                // M√•ltidsformul√§r
                h2AddMeal: "L√§gg till m√•ltid",
                labelMealType: "M√•ltid:",
                labelFoodItem: "Livsmedel:",
                labelAmount: "M√§ngd:",
                h3CalculatedIntake: "Ber√§knat intag:",
                buttonAddMeal: "L√§gg till",
                h2AddCustomFood: "ü•© L√§gg till eget livsmedel",
                labelProtein: "Protein (g/100g):",
                labelFat: "Fett (g/100g):",
                labelCarbs: "Kolhydrater (g/100g):",
                labelCalories: "Kalorier (kcal/100g):",
                labelLiverFriendly: "Leverv√§nlig:",
                customFoodFriendlyDesc: "Markera om livsmedlet st√∂djer leverh√§lsan.",
                h2LiverHealthReport: "üéØ Leverh√§lsorapport",
                mealTableTitle: "M√•ltider f√∂r",

                // M√•ltidstyper
                mealTypes: {
                    "Frukost": "Frukost",
                    "Lunch": "Lunch",
                    "Mellanm√•l": "Mellanm√•l",
                    "Middag": "Middag"
                },
                // Enheter (nyckeln √§r vikten i gram / 100g)
                units: [
                    { value: "100", text: "gram (g)" },
                    { value: "100", text: "dl (c:a 1 dl = 100g)" },
                    { value: "50", text: "st (c:a 50g/st)" },
                    { value: "1", text: "ml (kryddm√•tt, c:a 1g/ml)" },
                    { value: "5", text: "tsk (tesked, c:a 5g/tsk)" },
                    { value: "15", text: "msk (matsked, c:a 15g/msk)" },
                    { value: "50", text: "0.5 dl (c:a 50g)" }
                ],
                // Mat√∂vers√§ttningar (Svenskt namn som nyckel)
                foodNames: {
                    "Avokado": "Avokado",
                    "Bl√•b√§r": "Bl√•b√§r",
                    "Broccoli": "Broccoli",
                    "Brunt ris": "Brunt ris",
                    "Fullkornsbr√∂d": "Fullkornsbr√∂d",
                    "Kycklingbr√∂st (grillad)": "Kycklingbr√∂st (grillad)",
                    "Lax (ugnsbakad)": "Lax (ugnsbakad)",
                    "Spenat": "Spenat",
                    "Mor√∂tter": "Mor√∂tter",
                    "Havregryn": "Havregryn",
                    "Quinoa": "Quinoa",
                    "Valn√∂tter": "Valn√∂tter",
                    "Mandlar": "Mandlar",
                    "Torsk (fil√©)": "Torsk (fil√©)",
                    "√Ñgg (kokt)": "√Ñgg (kokt)",
                    "Olivolja (extra virgin)": "Olivolja (extra virgin)",
                    "Kaffe (svart)": "Kaffe (svart)",
                    "Grapefrukt": "Grapefrukt",
                    "Linser (kokta)": "Linser (kokta)",
                    "Kik√§rtor (kokta)": "Kik√§rtor (kokta)",
                    "Kalkonk√∂tt (magert)": "Kalkonk√∂tt (magert)",
                    "Fet yoghurt (os√∂tad)": "Fet yoghurt (os√∂tad)",
                    "√Ñpple": "√Ñpple",
                    "Apelsin": "Apelsin",
                    "Jordgubbar": "Jordgubbar",
                    "S√∂tpotatis (bakad)": "S√∂tpotatis (bakad)",
                    "Gr√∂nk√•l": "Gr√∂nk√•l",
                    "L√∂k": "L√∂k",
                    "N√∂tk√∂tt (fettrik)": "N√∂tk√∂tt (fettrik)",
                    "L√§sk (s√∂tad)": "L√§sk (s√∂tad)",
                    "Vitt br√∂d": "Vitt br√∂d",
                    "Pommes frites": "Pommes frites",
                    "Godis (gel√©)": "Godis (gel√©)",
                    "Bacon": "Bacon",
                    "Korv (med h√∂g fetthalt)": "Korv (med h√∂g fetthalt)",
                    "Raffinerat socker": "Raffinerat socker",
                    "Energidryck (s√∂tad)": "Energidryck (s√∂tad)",
                    "Kex (s√∂ta)": "Kex (s√∂ta)"
                },
                // Tabellrubriker
                tableHeaders: {
                    MealType: "M√•ltid",
                    FoodItem: "Livsmedel",
                    Amount: "M√§ngd",
                    Protein: "Protein",
                    Fat: "Fett",
                    Carbs: "Kolhydrater",
                    Calories: "Kalorier",
                    LiverFriendly: "Leverv√§nlig",
                    DeleteMeal: "Ta bort",
                },
                // NYTT: Overview Titles
                overview: {
                    setGoals: "üèÜ S√§tt Dagliga M√•l",
                    goalCalories: "Kalorier (kcal):",
                    goalProtein: "Protein (g):",
                    goalFat: "Fett (g):",
                    goalCarbs: "Kolhydrater (g):",
                    placeholderCalories: "2000",
                    placeholderProtein: "100",
                    placeholderFat: "60",
                    placeholderCarbs: "250",

                    hydration: "üíß Hydrering",
                    intakeToday: "Intag idag:",
                    goal: "M√•l:",
                    placeholderWaterGoal: "S√§tt m√•l (ml)",

                    activity: "üèÉ‚Äç‚ôÄÔ∏è Aktivitet",
                    trainingToday: "Tr√§ning idag:",
                    placeholderActivityGoal: "S√§tt m√•l (min)",

                    totalProtein: "Totalt Protein",
                    totalFat: "Totalt Fett",
                    totalCarbs: "Totala Kolhydrater",
                    totalCalories: "Totala Kalorier",

                    dailyGoalStatus: "Daglig M√•lstatus",
                    dailyGoalStatusDesc: "J√§mf√∂r din dagliga prestation mot dina satta m√•l.",
                    calDistributionMacro: "Kalorif√∂rdelning fr√•n makronutrienter",
                    calDistributionLiver: "Kalorif√∂rdelning: Leverv√§nlig vs. Ej leverv√§nlig",
                    calorieTrend: "Kaloritrend (Sista 7 dagarna)",
                    calorieTrendDesc: "Visar det totala dagliga kaloriintaget baserat p√• loggade m√•ltider, j√§mf√∂rt med ditt m√•l.",
                    activityTrend: "Aktivitetstrend (Sista 7 dagarna)",
                    activityTrendDesc: "Visar loggade tr√§ningsminuter de senaste 7 dagarna, j√§mf√∂rt med ditt m√•l."
                },
                // NYTT: Journal Titles & Labels
                journal: {
                    writeEntry: "Skriv en journalanteckning",
                    mood: "Hum√∂r idag (1=D√•ligt, 5=Toppen):",
                    moodValue: "Valt hum√∂r:",
                    howAreYou: "Hur m√•r du idag?",
                    placeholder: "Beskriv dina symptom, din energi, eller andra tankar...",

                    trackMetrics: "üß™ Sp√•ra Journalv√§rden",
                    dateOfTest: "Datum f√∂r prov:",
                    metricValue: "V√§rde (Ex: ALAT, Kolesterol):",
                    metricResult: "Resultat:",
                    metricUnit: "Enhet (Ex: $\\mu$mol/L):",
                    placeholderMetricName: "T.ex. ALAT, Bilirubin",
                    placeholderMetricValue: "T.ex. 0.62",
                    placeholderMetricUnit: "T.ex. $\\mu$mol/L, mmol/L",

                    trend: "üìâ Journalv√§rdestrender",
                    trendDesc: "V√§lj ett sp√•rat v√§rde ovan f√∂r att se hur det f√∂r√§ndrats √∂ver tid.",
                    myNotesAndMetrics: "Mina anteckningar och V√§rden",
                    loggedMetrics: "Loggade Journalv√§rden",
                    journalEntriesLog: "Journalanteckningar", // Lokaliserad journal log rubrik
                    filterMood: "Filtrera Hum√∂r:",
                    searchText: "S√∂k text:",
                    searchPlaceholder: "S√∂k ord i texten...",
                    noFilterMatch: "Inga anteckningar matchar filtret.",
                    noEntriesYet: "Inga anteckningar √§n.",
                    noMetrics: "Inga journalv√§rden loggade √§n.",
                    dataTools: "üõ†Ô∏è Dataverktyg",
                    utilityDesc: "Anv√§nd verktygen f√∂r att s√§kerhetskopiera din data eller rensa din logg."
                }
            },
            en: {
                // Generella
                appTitle: "Liver Diet",
                today: "Today",
                prompts: {
                    unlockPassword: "Enter password to unlock dangerous features:",
                    confirmReplaceData: "Are you sure you want to replace your current data with the imported file?",
                    confirmResetData: "WARNING: Are you absolutely sure you want to reset all data? This cannot be undone!",
                    invalidName: "Please enter a unique name for the food item.",
                    metricValidation: "Please fill in date, value, result, and unit."
                },
                alerts: {
                    unlocked: "App is unlocked!",
                    wrongPassword: "Wrong password.",
                    locked: "App is locked.",
                    customFoodSuccess: (name) => `The food item "${name}" has been added and is now available in the list!`,
                    importError: "Error: File does not appear to be a valid Liver Diet backup file.",
                    jsonError: "Import error: Could not read file as JSON. Check the file format."
                },
                feedback: {
                    welcome: "Welcome!",
                    logFirstMeal: (date) => `Log your first meal to get a liver health report for ${date}.`,
                    excellent: "Excellent! ‚úÖ",
                    excellentMessage: "Your intake consists of 100% liver-friendly calories. Continue eating nutritiously and avoid processed foods!",
                    good: "Very Good! üåü",
                    goodMessage: (percentage, kcal, list) => `Only ${percentage}% of your caloric intake is non-liver-friendly. You're doing great! Try replacing these: <br>${list}`,
                    warning: "Review your diet! ‚ö†Ô∏è",
                    warningMessage: (percentage, kcal, list) => `${percentage}% of your intake (${kcal} kcal) comes from foods that are heavy on the liver. Focus on reducing the following: <br>${list}`,
                },
                buttons: {
                    locked: "Locked",
                    unlocked: "Unlocked",
                    saveGoals: "Save Goals",
                    setGoal: "Set Goal",
                    saveEntry: "üíæ Save Entry",
                    saveMetric: "+ Save Metric",
                    saveCustomFood: "+ Save Food", // Ny dedikerad knapp
                    export: "‚¨áÔ∏è Export Data",
                    import: "‚¨ÜÔ∏è Import Data",
                    reset: "üóëÔ∏è Reset All Data",
                },
                // NYTT: Navigation Titles
                nav: {
                    meals: "Meals",
                    overview: "Overview",
                    journal: "Journal & Tools"
                },
                // Meal Form
                h2AddMeal: "Add Meal",
                labelMealType: "Meal:",
                labelFoodItem: "Food Item:",
                labelAmount: "Amount:",
                h3CalculatedIntake: "Calculated Intake:",
                buttonAddMeal: "Add",
                h2AddCustomFood: "ü•© Add Custom Food",
                labelProtein: "Protein (g/100g):",
                labelFat: "Fat (g/100g):",
                labelCarbs: "Carbs (g/100g):",
                labelCalories: "Calories (kcal/100g):",
                labelLiverFriendly: "Liver Friendly:",
                customFoodFriendlyDesc: "Check if the food supports liver health.",
                h2LiverHealthReport: "üéØ Liver Health Report",
                mealTableTitle: "Meals for",
                // Meal Types
                mealTypes: {
                    "Frukost": "Breakfast",
                    "Lunch": "Lunch",
                    "Mellanm√•l": "Snack",
                    "Middag": "Dinner"
                },
                // Units
                units: [
                    { value: "100", text: "grams (g)" },
                    { value: "100", text: "dl (approx. 1 dl = 100g)" },
                    { value: "50", text: "pcs (approx. 50g/pc)" },
                    { value: "1", text: "ml (pinch, approx. 1g/ml)" },
                    { value: "5", text: "tsp (teaspoon, approx. 5g/tsp)" },
                    { value: "15", text: "tbsp (tablespoon, approx. 15g/tbsp)" },
                    { value: "50", text: "0.5 dl (approx. 50g)" }
                ],
                // Mat√∂vers√§ttningar (Svenskt namn som nyckel)
                foodNames: {
                    "Avokado": "Avocado",
                    "Bl√•b√§r": "Blueberries",
                    "Broccoli": "Broccoli",
                    "Brunt ris": "Brown rice",
                    "Fullkornsbr√∂d": "Whole grain bread",
                    "Kycklingbr√∂st (grillad)": "Chicken breast (grilled)",
                    "Lax (ugnsbakad)": "Salmon (baked)",
                    "Spenat": "Spinach",
                    "Mor√∂tter": "Carrots",
                    "Havregryn": "Oatmeal",
                    "Quinoa": "Quinoa",
                    "Valn√∂tter": "Walnuts",
                    "Mandlar": "Almonds",
                    "Torsk (fil√©)": "Cod (fillet)",
                    "√Ñgg (kokt)": "Egg (boiled)",
                    "Olivolja (extra virgin)": "Olive oil (extra virgin)",
                    "Kaffe (svart)": "Coffee (black)",
                    "Grapefrukt": "Grapefruit",
                    "Linser (kokta)": "Lentils (cooked)",
                    "Kik√§rtor (kokta)": "Chickpeas (cooked)",
                    "Kalkonk√∂tt (magert)": "Turkey meat (lean)",
                    "Fet yoghurt (os√∂tad)": "Fat yogurt (unsweetened)",
                    "√Ñpple": "Apple",
                    "Apelsin": "Orange",
                    "Jordgubbar": "Strawberries",
                    "S√∂tpotatis (bakad)": "Sweet potato (baked)",
                    "Gr√∂nk√•l": "Kale",
                    "L√∂k": "Onion",
                    "N√∂tk√∂tt (fettrik)": "Beef (fatty)",
                    "L√§sk (s√∂tad)": "Soda (sweetened)",
                    "Vitt br√∂d": "White bread",
                    "Pommes frites": "French fries",
                    "Godis (gel√©)": "Candy (jelly)",
                    "Bacon": "Bacon",
                    "Korv (med h√∂g fetthalt)": "Sausage (high fat)",
                    "Raffinerat socker": "Refined sugar",
                    "Energidryck (s√∂tad)": "Energy drink (sweetened)",
                    "Kex (s√∂ta)": "Biscuits (sweet)"
                },
                // Tabellrubriker
                tableHeaders: {
                    MealType: "Meal",
                    FoodItem: "Food Item",
                    Amount: "Amount",
                    Protein: "Protein",
                    Fat: "Fat",
                    Carbs: "Carbs",
                    Calories: "Calories",
                    LiverFriendly: "Liver Friendly",
                    DeleteMeal: "Delete",
                },
                // NYTT: Overview Titles
                overview: {
                    setGoals: "üèÜ Set Daily Goals",
                    goalCalories: "Calories (kcal):",
                    goalProtein: "Protein (g):",
                    goalFat: "Fat (g):",
                    goalCarbs: "Carbs (g):",
                    placeholderCalories: "2000",
                    placeholderProtein: "100",
                    placeholderFat: "60",
                    placeholderCarbs: "250",

                    hydration: "üíß Hydration",
                    intakeToday: "Intake today:",
                    goal: "Goal:",
                    placeholderWaterGoal: "Set goal (ml)",

                    activity: "üèÉ‚Äç‚ôÄÔ∏è Activity",
                    trainingToday: "Activity today:",
                    placeholderActivityGoal: "Set goal (min)",

                    totalProtein: "Total Protein",
                    totalFat: "Total Fat",
                    totalCarbs: "Total Carbs",
                    totalCalories: "Total Calories",

                    dailyGoalStatus: "Daily Goal Status",
                    dailyGoalStatusDesc: "Compare your daily performance against your set goals.",
                    calDistributionMacro: "Calorie Distribution from Macronutrients",
                    calDistributionLiver: "Calorie Distribution: Liver Friendly vs. Not Liver Friendly",
                    calorieTrend: "Calorie Trend (Last 7 Days)",
                    calorieTrendDesc: "Shows total daily caloric intake based on logged meals, compared to your goal.",
                    activityTrend: "Activity Trend (Last 7 Days)",
                    activityTrendDesc: "Shows logged exercise minutes over the last 7 days, compared to your goal."
                },
                // NYTT: Journal Titles & Labels
                journal: {
                    writeEntry: "Write a Journal Entry",
                    mood: "Mood today (1=Bad, 5=Great):",
                    moodValue: "Selected Mood:",
                    howAreYou: "How are you feeling today?",
                    placeholder: "Describe your symptoms, energy, or other thoughts...",

                    trackMetrics: "üß™ Track Health Metrics",
                    dateOfTest: "Date of test:",
                    metricValue: "Metric (Ex: ALT, Cholesterol):",
                    metricResult: "Result:",
                    metricUnit: "Unit (Ex: $\\mu$mol/L):",
                    placeholderMetricName: "E.g. ALT, Bilirubin",
                    placeholderMetricValue: "E.g. 0.62",
                    placeholderMetricUnit: "E.g. $\\mu$mol/L, mmol/L",

                    trend: "üìâ Health Metric Trends",
                    trendDesc: "Select a tracked metric above to see how it has changed over time.",
                    myNotesAndMetrics: "My Notes and Metrics",
                    loggedMetrics: "Logged Health Metrics",
                    journalEntriesLog: "Journal Entries", // Lokaliserad journal log rubrik
                    filterMood: "Filter Mood:",
                    searchText: "Search Text:",
                    searchPlaceholder: "Search words in the text...",
                    noFilterMatch: "No entries match the filter.",
                    noEntriesYet: "No entries yet.",
                    noMetrics: "No health metrics logged yet.",
                    dataTools: "üõ†Ô∏è Data Tools",
                    utilityDesc: "Use the tools to back up your data or clear your log."
                }
            },
            es: {
                // Generella
                appTitle: "Dieta Hep√°tica",
                today: "Hoy",
                prompts: {
                    unlockPassword: "Ingrese la contrase√±a para desbloquear funciones peligrosas:",
                    confirmReplaceData: "¬øEst√° seguro de que desea reemplazar sus datos actuales con el archivo importado?",
                    confirmResetData: "ADVERTENCIA: ¬øEst√° absolutamente seguro de que desea restablecer todos los datos? ¬°Esto no se puede deshacer!",
                    invalidName: "Por favor, ingrese un nombre √∫nico para el alimento.",
                    metricValidation: "Por favor, rellene fecha, valor, resultado y unidad."
                },
                alerts: {
                    unlocked: "¬°Aplicaci√≥n desbloqueada!",
                    wrongPassword: "Contrase√±a incorrecta.",
                    locked: "Aplicaci√≥n bloqueada.",
                    customFoodSuccess: (name) => `¬°El alimento "${name}" ha sido a√±adido y ya est√° disponible en la lista!`,
                    importError: "Error: El archivo no parece ser un archivo de copia de seguridad de Dieta Hep√°tica v√°lido.",
                    jsonError: "Error de importaci√≥n: No se pudo leer el archivo como JSON. Verifique el formato del archivo."
                },
                feedback: {
                    welcome: "¬°Bienvenido!",
                    logFirstMeal: (date) => `Registre su primera comida para obtener un informe de salud hep√°tica para ${date}.`,
                    excellent: "¬°Excelente! ‚úÖ",
                    excellentMessage: "Su ingesta consiste en un 100% de calor√≠as amigables con el h√≠gado. ¬°Siga comiendo nutritivamente y evite los alimentos procesados!",
                    good: "¬°Muy Bien! üåü",
                    goodMessage: (percentage, kcal, list) => `Solo el ${percentage}% de su ingesta cal√≥rica no es amigable con el h√≠gado. ¬°Le est√° yendo bien! Intente reemplazar estos: <br>${list}`,
                    warning: "¬°Revise su dieta! ‚ö†Ô∏è",
                    warningMessage: (percentage, kcal, list) => `El ${percentage}% de su ingesta (${kcal} kcal) proviene de alimentos que son pesados para el h√≠gado. Conc√©ntrese en reducir lo siguiente: <br>${list}`,
                },
                buttons: {
                    locked: "Bloqueado",
                    unlocked: "Desbloqueado",
                    saveGoals: "Guardar Metas",
                    setGoal: "Establecer Meta",
                    saveEntry: "üíæ Guardar Entrada",
                    saveMetric: "+ Guardar Valor",
                    saveCustomFood: "+ Guardar Alimento", // Ny dedikerad knapp
                    export: "‚¨áÔ∏è Exportar Datos",
                    import: "‚¨ÜÔ∏è Importar Datos",
                    reset: "üóëÔ∏è Restablecer Datos",
                },
                // NYTT: Navigation Titles
                nav: {
                    meals: "Comidas",
                    overview: "Resumen",
                    journal: "Diario y Herramientas"
                },
                // Meal Form
                h2AddMeal: "A√±adir Comida",
                labelMealType: "Tipo de Comida:",
                labelFoodItem: "Alimento:",
                labelAmount: "Cantidad:",
                h3CalculatedIntake: "Ingesta Calculada:",
                buttonAddMeal: "A√±adir",
                h2AddCustomFood: "ü•© A√±adir Alimento Personalizado",
                labelProtein: "Prote√≠na (g/100g):",
                labelFat: "Grasa (g/100g):",
                labelCarbs: "Carbohidratos (g/100g):",
                labelCalories: "Calor√≠as (kcal/100g):",
                labelLiverFriendly: "Amigable con el H√≠gado:",
                customFoodFriendlyDesc: "Marque si el alimento apoya la salud hep√°tica.",
                h2LiverHealthReport: "üéØ Informe de Salud Hep√°tica",
                mealTableTitle: "Comidas de",
                // Meal Types
                mealTypes: {
                    "Frukost": "Desayuno",
                    "Lunch": "Almuerzo",
                    "Mellanm√•l": "Merienda",
                    "Middag": "Cena"
                },
                // Units
                units: [
                    { value: "100", text: "gramos (g)" },
                    { value: "100", text: "dl (aprox. 1 dl = 100g)" },
                    { value: "50", text: "ud (aprox. 50g/ud)" },
                    { value: "1", text: "ml (pizca, aprox. 1g/ml)" },
                    { value: "5", text: "cdta (cucharadita, aprox. 5g/cdta)" },
                    { value: "15", text: "cda (cucharada, aprox. 15g/cda)" },
                    { value: "50", text: "0.5 dl (aprox. 50g)" }
                ],
                // Mat√∂vers√§ttningar (Svenskt namn som nyckel)
                foodNames: {
                    "Avokado": "Aguacate",
                    "Bl√•b√§r": "Ar√°ndanos",
                    "Broccoli": "Br√≥coli",
                    "Brunt ris": "Arroz integral",
                    "Fullkornsbr√∂d": "Pan integral",
                    "Kycklingbr√∂st (grillad)": "Pechuga de pollo (a la parrilla)",
                    "Lax (ugnsbakad)": "Salm√≥n (al horno)",
                    "Spenat": "Espinacas",
                    "Mor√∂tter": "Zanahorias",
                    "Havregryn": "Avena",
                    "Quinoa": "Quinoa",
                    "Valn√∂tter": "Nueces",
                    "Mandlar": "Almendras",
                    "Torsk (fil√©)": "Bacalao (filete)",
                    "√Ñgg (kokt)": "Huevo (cocido)",
                    "Olivolja (extra virgin)": "Aceite de oliva (virgen extra)",
                    "Kaffe (svart)": "Caf√© (negro)",
                    "Grapefrukt": "Pomelo",
                    "Linser (kokta)": "Lentejas (cocidas)",
                    "Kik√§rtor (kokta)": "Garbanzos (cocidos)",
                    "Kalkonk√∂tt (magert)": "Carne de pavo (magra)",
                    "Fet yoghurt (os√∂tad)": "Yogur entero (sin az√∫car)",
                    "√Ñpple": "Manzana",
                    "Apelsin": "Naranja",
                    "Jordgubbar": "Fresas",
                    "S√∂tpotatis (bakad)": "Batata (asada)",
                    "Gr√∂nk√•l": "Col rizada",
                    "L√∂k": "Cebolla",
                    "N√∂tk√∂tt (fettrik)": "Carne de res (grasosa)",
                    "L√§sk (s√∂tad)": "Refresco (endulzado)",
                    "Vitt br√∂d": "Pan blanco",
                    "Pommes frites": "Papas fritas",
                    "Godis (gel√©)": "Golosinas (gelatina)",
                    "Bacon": "Tocino",
                    "Korv (med h√∂g fetthalt)": "Salchicha (alta en grasa)",
                    "Raffinerat socker": "Az√∫car refinada",
                    "Energidryck (s√∂tad)": "Bebida energ√©tica (endulzada)",
                    "Kex (s√∂ta)": "Galletas (dulces)"
                },
                // Tabellrubriker
                tableHeaders: {
                    MealType: "Comida",
                    FoodItem: "Alimento",
                    Amount: "Cantidad",
                    Protein: "Prote√≠na",
                    Fat: "Grasa",
                    Carbs: "Carbohidratos",
                    Calories: "Calor√≠as",
                    LiverFriendly: "Amigable",
                    DeleteMeal: "Eliminar",
                },
                // NYTT: Overview Titles
                overview: {
                    setGoals: "üèÜ Establecer Metas Diarias",
                    goalCalories: "Calor√≠as (kcal):",
                    goalProtein: "Prote√≠na (g):",
                    goalFat: "Grasa (g):",
                    goalCarbs: "Carbohidratos (g):",
                    placeholderCalories: "2000",
                    placeholderProtein: "100",
                    placeholderFat: "60",
                    placeholderCarbs: "250",

                    hydration: "üíß Hidrataci√≥n",
                    intakeToday: "Ingesta hoy:",
                    goal: "Meta:",
                    placeholderWaterGoal: "Establecer meta (ml)",

                    activity: "üèÉ‚Äç‚ôÄÔ∏è Actividad",
                    trainingToday: "Actividad hoy:",
                    placeholderActivityGoal: "Establecer meta (min)",

                    totalProtein: "Prote√≠na Total",
                    totalFat: "Grasa Total",
                    totalCarbs: "Carbohidratos Totales",
                    totalCalories: "Calor√≠as Totales",

                    dailyGoalStatus: "Estado de Meta Diaria",
                    dailyGoalStatusDesc: "Compare su rendimiento diario con sus metas establecidas.",
                    calDistributionMacro: "Distribuci√≥n de Calor√≠as por Macronutrientes",
                    calDistributionLiver: "Distribuci√≥n de Calor√≠as: Amigable vs. No Amigable con el H√≠gado",
                    calorieTrend: "Tendencia de Calor√≠as (√öltimos 7 D√≠as)",
                    calorieTrendDesc: "Muestra la ingesta cal√≥rica diaria total basada en las comidas registradas, comparada con su meta.",
                    activityTrend: "Tendencia de Actividad (√öltimos 7 D√≠as)",
                    activityTrendDesc: "Muestra los minutos de ejercicio registrados durante los √∫ltimos 7 d√≠as, comparados con su meta."
                },
                // NYTT: Journal Titles & Labels
                journal: {
                    writeEntry: "Escribir una Entrada en el Diario",
                    mood: "√Ånimo hoy (1=Mal, 5=Excelente):",
                    moodValue: "√Ånimo Seleccionado:",
                    howAreYou: "¬øC√≥mo se siente hoy?",
                    placeholder: "Describa sus s√≠ntomas, energ√≠a u otros pensamientos...",

                    trackMetrics: "üß™ Rastrear Valores de Salud",
                    dateOfTest: "Fecha de la prueba:",
                    metricValue: "Valor (Ej: ALT, Colesterol):",
                    metricResult: "Resultado:",
                    metricUnit: "Unidad (Ej: $\\mu$mol/L):",
                    placeholderMetricName: "Ej. ALT, Bilirubina",
                    placeholderMetricValue: "Ej. 0.62",
                    placeholderMetricUnit: "Ej. $\\mu$mol/L, mmol/L",

                    trend: "üìâ Tendencias de Valores de Salud",
                    trendDesc: "Seleccione un valor rastreado arriba para ver c√≥mo ha cambiado con el tiempo.",
                    myNotesAndMetrics: "Mis Notas y Valores",
                    loggedMetrics: "Valores de Salud Registrados",
                    journalEntriesLog: "Entradas del Diario", // Lokaliserad journal log rubrik
                    filterMood: "Filtrar √Ånimo:",
                    searchText: "Buscar Texto:",
                    searchPlaceholder: "Buscar palabras en el texto...",
                    noFilterMatch: "No hay entradas que coincidan con el filtro.",
                    noEntriesYet: "A√∫n no hay entradas.",
                    noMetrics: "No se han registrado valores de salud a√∫n.",
                    dataTools: "üõ†Ô∏è Herramientas de Datos",
                    utilityDesc: "Use las herramientas para hacer una copia de seguridad de sus datos o borrar su registro."
                }
            },
            it: {
                // Generella
                appTitle: "Dieta Epatica",
                today: "Oggi",
                actions: {
                    unlockPassword: "Inserisci la password per sbloccare le funzioni pericolose:",
                    confirmReplaceData: "Sei sicuro di voler sostituire i tuoi dati attuali con il file importato?",
                    confirmResetData: "ATTENZIONE: Sei assolutamente sicuro di voler resettare tutti i dati? Questa azione non pu√≤ essere annullata!",
                    invalidName: "Si prega di inserire un nome univoco per l'alimento.",
                    metricValidation: "Si prega di compilare data, valore, risultato e unit√†."
                },
                alerts: {
                    unlocked: "App sbloccata!",
                    wrongPassword: "Password errata.",
                    locked: "App bloccata.",
                    customFoodSuccess: (name) => `L'alimento "${name}" √® stato aggiunto ed √® ora disponibile nell'elenco!`,
                    importError: "Errore: Il file non sembra essere un file di backup valido per la Dieta Epatica.",
                    jsonError: "Errore di importazione: Impossibile leggere il file come JSON. Controlla il formato del file."
                },
                feedback: {
                    welcome: "Benvenuto!",
                    logFirstMeal: (date) => `Registra il tuo primo pasto per ottenere un rapporto sulla salute del fegato per ${date}.`,
                    excellent: "Eccellente! ‚úÖ",
                    excellentMessage: "La tua assunzione consiste nel 100% di calorie amiche del fegato. Continua a mangiare nutriente ed evita i cibi processati!",
                    good: "Molto Bene! üåü",
                    goodMessage: (percentage, kcal, list) => `Solo il ${percentage}% del tuo apporto calorico non √® amico del fegato. Stai andando bene! Prova a sostituire questi: <br>${list}`,
                    warning: "Rivedi la tua dieta! ‚ö†Ô∏è",
                    warningMessage: (percentage, kcal, list) => `Il ${percentage}% del tuo apporto (${kcal} kcal) proviene da alimenti pesanti per il fegato. Concentrati sulla riduzione di quanto segue: <br>${list}`,
                },
                buttons: {
                    locked: "Bloccato",
                    unlocked: "Sbloccato",
                    saveGoals: "Salva Obiettivi",
                    setGoal: "Imposta Obiettivo",
                    saveEntry: "üíæ Salva Voce",
                    saveMetric: "+ Salva Valore",
                    saveCustomFood: "+ Salva Alimento", // Ny dedikerad knapp
                    export: "‚¨áÔ∏è Esporta Dati",
                    import: "‚¨ÜÔ∏è Importa Dati",
                    reset: "üóëÔ∏è Resetta Tutti i Dati",
                },
                // NYTT: Navigation Titles
                nav: {
                    meals: "Pasti",
                    overview: "Panoramica",
                    journal: "Diario e Strumenti"
                },
                // Meal Form
                h2AddMeal: "Aggiungi Pasto",
                labelMealType: "Pasto:",
                labelFoodItem: "Alimento:",
                labelAmount: "Quantit√†:",
                h3CalculatedIntake: "Assunzione Calcolata:",
                buttonAddMeal: "Aggiungi",
                h2AddCustomFood: "ü•© Aggiungi Alimento Personalizzato",
                labelProtein: "Proteine (g/100g):",
                labelFat: "Grassi (g/100g):",
                labelCarbs: "Carboidrati (g/100g):",
                labelCalories: "Calorie (kcal/100g):",
                labelLiverFriendly: "Amico del Fegato:",
                customFoodFriendlyDesc: "Seleziona se l'alimento supporta la salute del fegato.",
                h2LiverHealthReport: "üéØ Rapporto Salute del Fegato",
                mealTableTitle: "Pasti per",
                // Meal Types
                mealTypes: {
                    "Frukost": "Colazione",
                    "Lunch": "Pranzo",
                    "Mellanm√•l": "Spuntino",
                    "Middag": "Cena"
                },
                // Units
                units: [
                    { value: "100", text: "grammi (g)" },
                    { value: "100", text: "dl (circa 1 dl = 100g)" },
                    { value: "50", text: "pz (circa 50g/pz)" },
                    { value: "1", text: "ml (pizzico, circa 1g/ml)" },
                    { value: "5", text: "cucchiaino (circa 5g/cucchiaino)" },
                    { value: "15", text: "cucchiaio (circa 15g/cucchiaio)" },
                    { value: "50", text: "0.5 dl (circa 50g)" }
                ],
                // Mat√∂vers√§ttningar (Svenskt namn som nyckel)
                foodNames: {
                    "Avokado": "Avocado",
                    "Bl√•b√§r": "Mirtilli",
                    "Broccoli": "Broccoli",
                    "Brunt ris": "Riso integrale",
                    "Fullkornsbr√∂d": "Pane integrale",
                    "Kycklingbr√∂st (grillad)": "Petto di pollo (alla griglia)",
                    "Lax (ugnsbakad)": "Salmone (al forno)",
                    "Spenat": "Spinaci",
                    "Mor√∂tter": "Carote",
                    "Havregryn": "Fiocchi d'avena",
                    "Quinoa": "Quinoa",
                    "Valn√∂tter": "Noci",
                    "Mandlar": "Mandorle",
                    "Torsk (fil√©)": "Merluzzo (filetto)",
                    "√Ñgg (kokt)": "Uovo (sodo)",
                    "Olivolja (extra virgin)": "Olio d'oliva (extra vergine)",
                    "Kaffe (svart)": "Caff√® (nero)",
                    "Grapefrukt": "Pompelmo",
                    "Linser (kokta)": "Lenticchie (cotte)",
                    "Kik√§rtor (kokta)": "Ceci (cotti)",
                    "Kalkonk√∂tt (magert)": "Carne di tacchino (magra)",
                    "Fet yoghurt (os√∂tad)": "Yogurt intero (non zuccherato)",
                    "√Ñpple": "Mela",
                    "Apelsin": "Arancia",
                    "Jordgubbar": "Fragole",
                    "S√∂tpotatis (bakad)": "Patata dolce (al forno)",
                    "Gr√∂nk√•l": "Cavolo nero",
                    "L√∂k": "Cipolla",
                    "N√∂tk√∂tt (fettrik)": "Carne di manzo (grassa)",
                    "L√§sk (s√∂tad)": "Bibita (zuccherata)",
                    "Vitt br√∂d": "Pane bianco",
                    "Pommes frites": "Patatine fritte",
                    "Godis (gel√©)": "Caramelle (gelatina)",
                    "Bacon": "Pancetta",
                    "Korv (med h√∂g fetthalt)": "Salsiccia (alto contenuto di grassi)",
                    "Raffinerat socker": "Zucchero raffinato",
                    "Energidryck (s√∂tad)": "Energy drink (zuccherata)",
                    "Kex (s√∂ta)": "Biscotti (dolci)"
                },
                // Tabellrubriker
                tableHeaders: {
                    MealType: "Pasto",
                    FoodItem: "Alimento",
                    Amount: "Quantit√†",
                    Protein: "Proteine",
                    Fat: "Grassi",
                    Carbs: "Carboidrati",
                    Calories: "Calorie",
                    LiverFriendly: "Amico",
                    DeleteMeal: "Elimina",
                },
                // NYTT: Overview Titles
                overview: {
                    setGoals: "üèÜ Imposta Obiettivi Giornalieri",
                    goalCalories: "Calorie (kcal):",
                    goalProtein: "Proteine (g):",
                    goalFat: "Grassi (g):",
                    goalCarbs: "Carboidrati (g):",
                    placeholderCalories: "2000",
                    placeholderProtein: "100",
                    placeholderFat: "60",
                    placeholderCarbs: "250",

                    hydration: "üíß Idratazione",
                    intakeToday: "Assunzione oggi:",
                    goal: "Obiettivo:",
                    placeholderWaterGoal: "Imposta obiettivo (ml)",

                    activity: "üèÉ‚Äç‚ôÄÔ∏è Attivit√†",
                    trainingToday: "Attivit√† oggi:",
                    placeholderActivityGoal: "Imposta obiettivo (min)",

                    totalProtein: "Proteine Totali",
                    totalFat: "Grassi Totali",
                    totalCarbs: "Carboidrati Totali",
                    totalCalories: "Calorie Totali",

                    dailyGoalStatus: "Stato Obiettivo Giornaliero",
                    dailyGoalStatusDesc: "Confronta la tua performance giornaliera con gli obiettivi impostati.",
                    calDistributionMacro: "Distribuzione Calorie da Macronutrienti",
                    calDistributionLiver: "Distribuzione Calorie: Amico del Fegato vs. Non Amico del Fegato",
                    calorieTrend: "Andamento Calorie (Ultimi 7 Giorni)",
                    calorieTrendDesc: "Mostra l'assunzione calorica giornaliera totale basata sui pasti registrati, rispetto al tuo obiettivo.",
                    activityTrend: "Andamento Attivit√† (Ultimi 7 Giorni)",
                    activityTrendDesc: "Mostra i minuti di esercizio registrati negli ultimi 7 giorni, rispetto al tuo obiettivo."
                },
                // NYTT: Journal Titles & Labels
                journal: {
                    writeEntry: "Scrivi una Voce di Diario",
                    mood: "Umore oggi (1=Male, 5=Ottimo):",
                    moodValue: "Umore Selezionato:",
                    howAreYou: "Come ti senti oggi?",
                    placeholder: "Descrivi i tuoi sintomi, energia o altri pens thoughts...",

                    trackMetrics: "üß™ Traccia i Valori di Salute",
                    dateOfTest: "Data del test:",
                    metricValue: "Valore (Es: ALT, Colesterol):",
                    metricResult: "Risultato:",
                    metricUnit: "Unit√† (Es: $\\mu$mol/L):",
                    placeholderMetricName: "Es. ALT, Bilirubina",
                    placeholderMetricValue: "Es. 0.62",
                    placeholderMetricUnit: "Es. $\\mu$mol/L, mmol/L",

                    trend: "üìâ Tendenze dei Valori di Salute",
                    trendDesc: "Selecciona un valor tracciado arriba para ver c√≥mo ha cambiado con el tiempo.",
                    myNotesAndMetrics: "Le Mie Note e Valori",
                    loggedMetrics: "Valori di Salute Registrati",
                    journalEntriesLog: "Voci di Diario", // Lokaliserad journal log rubrik
                    filterMood: "Filtra Umore:",
                    searchText: "Cerca Testo:",
                    searchPlaceholder: "Cerca parole nel testo...",
                    noFilterMatch: "Nessuna voce corrisponde al filtro.",
                    noEntriesYet: "Ancora nessuna voce.",
                    noMetrics: "Ancora nessun valore di salute registrato.",
                    dataTools: "üõ†Ô∏è Strumenti Dati",
                    utilityDesc: "Usa gli strumenti per eseguire il backup dei tuoi dati o cancellare il registro."
                }
            }
        };

        // Global referens till det aktuella spr√•ket.
        var T = Translations[currentLang];
        // --- SLUT LOKALISERING ---


        // Funktion f√∂r att byta spr√•k och uppdatera UI
        function setLanguage(langCode) {
            currentLang = langCode;
            localStorage.setItem('appLanguage', langCode);
            T = Translations[currentLang]; // Uppdatera globala T-referensen
            updateStaticUI();
            initializeMealInputs(); // Fyll i m√•ltidslistor p√• nytt spr√•k
            populateFoodSelect(); // Uppdatera livsmedelsrullistan
            updateUI(); // Uppdatera resten av gr√§nssnittet
        }

        // Funktion f√∂r att uppdatera statiska UI-element efter spr√•kbyte
        function updateStaticUI() {
            const T = Translations[currentLang];

            // --- SIDOMENY OCH NAVIGERING ---
            document.querySelector('.sidebar h1').textContent = `üåø ${T.appTitle}`;
            // Fix: Anv√§nd ID:n f√∂r att uppdatera navigationsspan-elementen
            document.getElementById("navMeals").textContent = T.nav.meals;
            document.getElementById("navOverview").textContent = T.nav.overview;
            document.getElementById("navJournal").textContent = T.nav.journal;

            // --- M√ÖLTIDSSIDA (STATISK TEXT) ---
            document.getElementById("h2AddMeal").textContent = T.h2AddMeal;
            document.getElementById("labelMealType").textContent = T.labelMealType;
            document.getElementById("labelFoodSelect").textContent = T.labelFoodItem;
            document.getElementById("labelAmountValue").textContent = T.labelAmount;
            document.getElementById("h3CalculatedIntake").textContent = T.h3CalculatedIntake;
            document.getElementById("buttonAddMeal").innerHTML = `‚ûï ${T.buttonAddMeal}`;

            document.getElementById("h2AddCustomFood").textContent = T.h2AddCustomFood;
            document.getElementById("labelProtein").textContent = T.labelProtein;
            document.getElementById("labelFat").textContent = T.labelFat;
            document.getElementById("labelCarbs").textContent = T.labelCarbs;
            document.getElementById("labelCalories").textContent = T.labelCalories;
            document.getElementById("labelLiverFriendly").textContent = T.labelLiverFriendly;
            document.getElementById("customFoodFriendlyDesc").textContent = T.customFoodFriendlyDesc;
            document.getElementById("saveCustomFoodButton").textContent = T.buttons.saveCustomFood;

            document.getElementById("h2LiverHealthReport").textContent = T.h2LiverHealthReport;
            document.getElementById("h2MealsForDate").textContent = T.mealTableTitle; // Rubrik f√∂r m√•ltidstabell

            // Tabellrubriker
            document.getElementById("thMealType").textContent = T.tableHeaders.MealType;
            document.getElementById("thFoodItem").textContent = T.tableHeaders.FoodItem;
            document.getElementById("thAmount").textContent = T.tableHeaders.Amount;
            document.getElementById("thProtein").textContent = T.tableHeaders.Protein;
            document.getElementById("thFat").textContent = T.tableHeaders.Fat;
            document.getElementById("thCarbs").textContent = T.tableHeaders.Carbs;
            document.getElementById("thCalories").textContent = T.tableHeaders.Calories;
            document.getElementById("thLiverFriendly").textContent = T.tableHeaders.LiverFriendly;
            document.getElementById("thDeleteMeal").textContent = T.tableHeaders.DeleteMeal;

            // --- √ñVERSIKTSSIDA (STATISK TEXT OCH PLATSH√ÖLLARE) ---
            // M√•lhantering
            document.getElementById('h2SetDailyGoals').textContent = T.overview.setGoals;
            document.getElementById('labelGoalCalories').textContent = T.overview.goalCalories;
            document.getElementById('labelGoalProtein').textContent = T.overview.goalProtein;
            document.getElementById('labelGoalFat').textContent = T.overview.goalFat;
            document.getElementById('labelGoalCarbs').textContent = T.overview.goalCarbs;
            document.getElementById('saveGoalsButton').textContent = T.buttons.saveGoals;

            document.getElementById('goalCalories').placeholder = T.overview.placeholderCalories;
            document.getElementById('goalProtein').placeholder = T.overview.placeholderProtein;
            document.getElementById('goalFat').placeholder = T.overview.placeholderFat;
            document.getElementById('goalCarbs').placeholder = T.overview.placeholderCarbs;

            // Hydrering
            document.getElementById('h2Hydration').textContent = T.overview.hydration;
            // h3-texterna uppdateras dynamiskt i updateWaterDisplay, vi uppdaterar platsh√•llaren h√§r
            document.getElementById('waterGoalInput').placeholder = T.overview.placeholderWaterGoal;
            document.getElementById('setWaterGoalButton').textContent = T.buttons.setGoal;

            // Aktivitet
            document.getElementById('h2Activity').textContent = T.overview.activity;
            // h3-texterna uppdateras dynamiskt i updateActivityDisplay, vi uppdaterar platsh√•llaren h√§r
            document.getElementById('activityGoalInput').placeholder = T.overview.placeholderActivityGoal;
            document.getElementById('setActivityGoalButton').textContent = T.buttons.setGoal;

            // Statistik kort rubriker
            document.getElementById('h3TotalProtein').textContent = T.overview.totalProtein;
            document.getElementById('h3TotalFat').textContent = T.overview.totalFat;
            document.getElementById('h3TotalCarbs').textContent = T.overview.totalCarbs;
            document.getElementById('h3TotalCalories').textContent = T.overview.totalCalories;

            // Diagram rubriker och beskrivningar
            document.getElementById('h2DailyGoalStatus').textContent = T.overview.dailyGoalStatus;
            document.getElementById('pDailyGoalStatusDesc').textContent = T.overview.dailyGoalStatusDesc;
            document.getElementById('h2CalDistributionMacro').textContent = T.overview.calDistributionMacro;
            document.getElementById('h2CalDistributionLiver').textContent = T.overview.calDistributionLiver;
            document.getElementById('h2CalorieTrend').textContent = T.overview.calorieTrend;
            document.getElementById('pCalorieTrendDesc').textContent = T.overview.calorieTrendDesc;
            document.getElementById('h2ActivityTrend').textContent = T.overview.activityTrend;
            document.getElementById('pActivityTrendDesc').textContent = T.overview.activityTrendDesc;

            // --- JOURNAL SIDA (STATISK TEXT OCH PLATSH√ÖLLARE) ---
            // Journalanteckning
            document.getElementById('h2WriteJournalEntry').textContent = T.journal.writeEntry;
            document.getElementById('labelMood').textContent = T.journal.mood;
            // Uppdatera hum√∂r-etiketten korrekt utan att f√∂rlora span-v√§rdet
            const moodValueText = document.getElementById("moodValueText");
            if (moodValueText) {
                moodValueText.textContent = T.journal.moodValue;
            }
            document.getElementById('labelHowAreYou').textContent = T.journal.howAreYou;
            document.getElementById('journalText').placeholder = T.journal.placeholder;
            document.getElementById('saveJournalButton').innerHTML = T.buttons.saveEntry;

            // Journalv√§rden
            document.getElementById('h2TrackHealthMetrics').textContent = T.journal.trackMetrics;
            document.getElementById('labelDateOfTest').textContent = T.journal.dateOfTest;
            document.getElementById('labelMetricValue').textContent = T.journal.metricValue;
            document.getElementById('labelMetricResult').textContent = T.journal.metricResult;
            document.getElementById('labelMetricUnit').textContent = T.journal.metricUnit;
            document.getElementById('metricName').placeholder = T.journal.placeholderMetricName;
            document.getElementById('metricValue').placeholder = T.journal.placeholderMetricValue;
            document.getElementById('metricUnit').placeholder = T.journal.placeholderMetricUnit;
            document.getElementById('saveMetricButton').innerHTML = T.buttons.saveMetric;

            // Journalv√§rde Trend
            document.getElementById('h2MetricTrend').textContent = T.journal.trend;
            document.getElementById('pMetricTrendDesc').textContent = T.journal.trendDesc;

            // Journal & Metrics Tabell
            document.getElementById('h2MyNotesAndMetrics').textContent = T.journal.myNotesAndMetrics;
            document.getElementById('h3LoggedMetrics').textContent = T.journal.loggedMetrics;
            // NY FIX: Anv√§nda lokaliserad str√§ng f√∂r journal log rubrik
            document.getElementById('h3JournalEntriesLog').textContent = T.journal.journalEntriesLog;
            document.getElementById('labelFilterMood').textContent = T.journal.filterMood;
            document.getElementById('labelSearchText').textContent = T.journal.searchText;
            document.getElementById('filterText').placeholder = T.journal.searchPlaceholder;

            // Dataverktyg
            document.getElementById("h2DataTools").textContent = T.journal.dataTools;
            document.getElementById('exportDataButton').innerHTML = T.buttons.export;
            document.getElementById('importDataButton').innerHTML = T.buttons.import;
            document.getElementById('resetDataButton').innerHTML = T.buttons.reset;
            document.getElementById("pUtilityDesc").textContent = T.journal.utilityDesc;

            // √ñvrigt
            updateLockUI();

            // S√§tt vald spr√•k i rullistan
            const langSelect = document.getElementById('languageSelect');
            if (langSelect) {
                langSelect.value = currentLang;
            }
        }


        // --- DATABAS & GLOBALA VARIABLER ---
        // Startdatabas med fasta livsmedel (ALLA NYCKLAR M√ÖSTE VARA SVENSKA OCH MATCHAS I foodNames!)
        const baseFoodDatabase = {
            // ** LEVERV√ÑNLIGA LIVSMEDEL (L√§mpliga f√∂r leverh√§lsa) **
            "Avokado": { protein: 2, fat: 15, carbs: 9, calories: 160, liverFriendly: true },
            "Bl√•b√§r": { protein: 0.7, fat: 0.3, carbs: 14.5, calories: 57, liverFriendly: true },
            "Broccoli": { protein: 3, fat: 0.3, carbs: 7, calories: 34, liverFriendly: true },
            "Brunt ris": { protein: 2.6, fat: 1.0, carbs: 23.0, calories: 111, liverFriendly: true },
            "Fullkornsbr√∂d": { protein: 13.0, fat: 3.5, carbs: 45.0, calories: 250, liverFriendly: true },
            "Kycklingbr√∂st (grillad)": { protein: 31, fat: 3.6, carbs: 0, calories: 165, liverFriendly: true },
            "Lax (ugnsbakad)": { protein: 22, fat: 13, carbs: 0, calories: 206, liverFriendly: true },
            "Spenat": { protein: 2.9, fat: 0.4, carbs: 3.6, calories: 23, liverFriendly: true },
            "Mor√∂tter": { protein: 0.9, fat: 0.2, carbs: 9.6, calories: 41, liverFriendly: true },
            "Havregryn": { protein: 17, fat: 7, carbs: 66, calories: 389, liverFriendly: true },
            "Quinoa": { protein: 14, fat: 6, carbs: 64, calories: 368, liverFriendly: true },
            "Valn√∂tter": { protein: 15, fat: 65, carbs: 14, calories: 654, liverFriendly: true },
            "Mandlar": { protein: 21, fat: 49, carbs: 22, calories: 579, liverFriendly: true },
            "Torsk (fil√©)": { protein: 18, fat: 0.9, carbs: 0, calories: 82, liverFriendly: true },
            "√Ñgg (kokt)": { protein: 13, fat: 11, carbs: 1.1, calories: 155, liverFriendly: true },
            "Olivolja (extra virgin)": { protein: 0, fat: 100, carbs: 0, calories: 884, liverFriendly: true },
            "Kaffe (svart)": { protein: 0.1, fat: 0, carbs: 0, calories: 1, liverFriendly: true },
            "Grapefrukt": { protein: 0.7, fat: 0.1, carbs: 8.4, calories: 33, liverFriendly: true },
            "Linser (kokta)": { protein: 9, fat: 0.4, carbs: 20, calories: 116, liverFriendly: true },
            "Kik√§rtor (kokta)": { protein: 8.8, fat: 2.6, carbs: 27, calories: 164, liverFriendly: true },
            "Kalkonk√∂tt (magert)": { protein: 29, fat: 1.5, carbs: 0, calories: 135, liverFriendly: true },
            "Fet yoghurt (os√∂tad)": { protein: 5, fat: 3.3, carbs: 4.7, calories: 61, liverFriendly: true },
            // NYTT: Extra frukter och gr√∂nsaker
            "√Ñpple": { protein: 0.3, fat: 0.2, carbs: 13.8, calories: 52, liverFriendly: true },
            "Apelsin": { protein: 0.9, fat: 0.1, carbs: 11.8, calories: 47, liverFriendly: true },
            "Jordgubbar": { protein: 0.7, fat: 0.3, carbs: 7.7, calories: 32, liverFriendly: true },
            "S√∂tpotatis (bakad)": { protein: 1.6, fat: 0.1, carbs: 20.1, calories: 86, liverFriendly: true },
            "Gr√∂nk√•l": { protein: 4.3, fat: 0.9, carbs: 8.8, calories: 49, liverFriendly: true },
            "L√∂k": { protein: 1.1, fat: 0.1, carbs: 9.3, calories: 40, liverFriendly: true },


            // ** ICKE-LEVERV√ÑNLIGA LIVSMEDEL (B√∂r intas med m√•tta) **
            "N√∂tk√∂tt (fettrik)": { protein: 26, fat: 15, carbs: 0, calories: 250, liverFriendly: false },
            "L√§sk (s√∂tad)": { protein: 0, fat: 0, carbs: 11, calories: 45, liverFriendly: false },
            "Vitt br√∂d": { protein: 9, fat: 3.2, carbs: 49, calories: 265, liverFriendly: false },
            "Pommes frites": { protein: 3.4, fat: 15, carbs: 41, calories: 312, liverFriendly: false },
            "Godis (gel√©)": { protein: 2, fat: 0.1, carbs: 75, calories: 320, liverFriendly: false },
            "Bacon": { protein: 37, fat: 42, carbs: 0, calories: 538, liverFriendly: false },
            "Korv (med h√∂g fetthalt)": { protein: 12, fat: 28, carbs: 2.5, calories: 315, liverFriendly: false },
            "Raffinerat socker": { protein: 0, fat: 0, carbs: 100, calories: 400, liverFriendly: false },
            "Energidryck (s√∂tad)": { protein: 0, fat: 0, carbs: 11, calories: 44, liverFriendly: false },
            "Kex (s√∂ta)": { protein: 8, fat: 20, carbs: 68, calories: 480, liverFriendly: false }
        };

        let foodDatabase = {};
        let customFoodDatabase = {};

        let allMeals = [];
        let journalEntries = [];
        let healthMetrics = []; // NYTT: F√∂r journalv√§rden
        let dietGoals = {};
        let waterGoal = 2500;
        let waterIntake = {};
        let activityGoal = 30;
        let activityMinutes = {};

        let nutritionChart;
        let liverFriendlyChart;
        let trendChart;
        let activityTrendChart;
        let goalStatusChart;
        let metricTrendChart; // NYTT: Journalv√§rdesdiagram

        // Globalt variabel f√∂r det valda datumet (YYYY-MM-DD)
        let currentDate = new Date().toISOString().split('T')[0];
        let currentCalendarDate = new Date(); // F√∂r kalendernavigering

        // --- INITIALISERING ---
        document.addEventListener("DOMContentLoaded", () => {
            // F√∂rs√∂k att ladda sparat spr√•k fr√•n localStorage f√∂rst
            const savedLang = localStorage.getItem('appLanguage');
            if (savedLang && Translations.hasOwnProperty(savedLang)) {
                currentLang = savedLang;
                T = Translations[currentLang];
            }

            loadData();
            updateStaticUI(); // Uppdatera alla statiska texter f√∂rst
            initializeMealInputs(); // NYTT: Fyller i m√•ltids- och enhetsrullistor
            populateFoodSelect();
            initializeChart();
            initializeLiverFriendlyChart();
            initializeTrendChart();
            initializeActivityTrendChart();
            initializeGoalStatusChart();
            initializeMetricTrendChart(); // NYTT: Initiera journaldiagram

            // Initialisera Kalender och Lyssna p√• √§ndringar
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            document.getElementById("mealDate").value = currentDate; // S√§tt dolda datumf√§ltet

            // Initialisera datumv√§ljaren f√∂r Journalv√§rden
            document.getElementById("metricDate").value = currentDate;

            // Lyssna p√• hum√∂rv√§ljaren i journalen
            const moodInput = document.getElementById("journalMood");
            const currentMoodValue = document.getElementById("currentMoodValue");
            if (moodInput) {
                moodInput.addEventListener('input', (e) => {
                    currentMoodValue.textContent = e.target.value;
                });
            }

            // Initialisera m√•l inputs vid laddning
            document.getElementById('goalCalories').value = dietGoals.calories || '';
            document.getElementById('goalProtein').value = dietGoals.protein || '';
            document.getElementById('goalFat').value = dietGoals.fat || '';
            document.getElementById('goalCarbs').value = dietGoals.carbs || '';

            // Initialisera nya inline m√•l-inputs
            document.getElementById('waterGoalInput').value = waterGoal || 2500;
            document.getElementById('activityGoalInput').value = activityGoal || 30;

            // Uppdatera l√•s UI baserat p√• isLocked initialt till true
            updateLockUI();

            // Initialisera f√∂rhandsgranskning och uppdatera UI
            updateUI();
            calculateMealPreview();
            renderMetricChart(); // Rita initialt journaldiagram
        });

        // NY FUNKTION: Fyller i m√•ltidstyper och enheter dynamiskt
        function initializeMealInputs() {
            const mealTypeSelect = document.getElementById("mealType");
            const amountUnitSelect = document.getElementById("amountUnit");

            // 1. Fyll i M√•ltidstyp-rullistan
            mealTypeSelect.innerHTML = '';
            Object.keys(T.mealTypes).forEach(key => {
                let opt = document.createElement("option");
                // Anv√§nd den √∂versatta str√§ngen f√∂r visning, men spara den svenska nyckeln som v√§rde
                opt.textContent = T.mealTypes[key];
                opt.value = key;
                mealTypeSelect.appendChild(opt);
            });

            // 2. Fyll i Enhet-rullistan
            amountUnitSelect.innerHTML = '';
            T.units.forEach(unit => {
                let opt = document.createElement("option");
                opt.value = unit.value;
                opt.textContent = unit.text;
                amountUnitSelect.appendChild(opt);
            });
        }

        // Funktion f√∂r att formatera datum till Svenskt format
        function formatDate(dateStr) {
            if (dateStr === new Date().toISOString().split('T')[0]) return T.today;

            // Anpassa datumformatering baserat p√• valt spr√•k (anv√§nder ISO-formatet i koden)
            let locale = 'sv-SE';
            switch (currentLang) {
                case 'en': locale = 'en-US'; break;
                case 'es': locale = 'es-ES'; break;
                case 'it': locale = 'it-IT'; break;
            }

            const [year, month, day] = dateStr.split('-').map(Number);
            const actualDate = new Date(year, month - 1, day);
            return actualDate.toLocaleDateString(locale, { year: 'numeric', month: 'long', day: 'numeric' });
        }

        // NY FIX: Uppdaterad f√∂r att visa √∂versatta livsmedelsnamn
        function populateFoodSelect() {
            // Kombinera basdatabasen med anv√§ndarens custom-data
            foodDatabase = { ...baseFoodDatabase, ...customFoodDatabase };
            const foodSelect = document.getElementById("foodSelect");
            foodSelect.innerHTML = ''; // Rensa gamla alternativ
            const currentFoodNames = T.foodNames;

            // Sortera efter det √∂versatta namnet
            const sortedFoodKeys = Object.keys(foodDatabase).sort((a, b) => {
                const nameA = (currentFoodNames[a] || a).toLowerCase();
                const nameB = (currentFoodNames[b] || b).toLowerCase();
                return nameA.localeCompare(nameB);
            });

            sortedFoodKeys.forEach(foodKey => {
                let opt = document.createElement("option");
                // V√§rdet √§r ALLTID den svenska nyckeln (f√∂r att matcha foodDatabase)
                opt.value = foodKey;

                const isCustom = customFoodDatabase.hasOwnProperty(foodKey);
                const displayName = currentFoodNames[foodKey] || foodKey;

                // Textinneh√•llet √§r det √∂versatta namnet, markerat med * om det √§r custom
                opt.textContent = isCustom ? `* ${displayName}` : displayName;

                foodSelect.appendChild(opt);
            });
        }

        // --- DIAGRAM INITIALISERING ---
        function initializeChart() {
            const ctx = document.getElementById("nutritionChart").getContext("2d");
            nutritionChart = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: [T.tableHeaders.Protein + " (kcal)", T.tableHeaders.Fat + " (kcal)", T.tableHeaders.Carbs + " (kcal)"],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ["rgba(59, 130, 246, 0.8)", "rgba(245, 158, 11, 0.8)", "rgba(16, 185, 129, 0.8)"],
                        borderColor: ["#ffffff", "#ffffff", "#ffffff"],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed.toFixed(0)} kcal` } } }
                }
            });
        }

        function initializeLiverFriendlyChart() {
            const ctx = document.getElementById("liverFriendlyChart").getContext("2d");
            liverFriendlyChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: [T.tableHeaders.LiverFriendly + " (Ja)", T.tableHeaders.LiverFriendly + " (Nej)"],
                    datasets: [{
                        label: T.tableHeaders.Calories + " (kcal)",
                        data: [0, 0],
                        backgroundColor: ["rgba(16, 185, 129, 0.7)", "rgba(239, 68, 68, 0.7)"],
                        borderColor: ["rgba(16, 185, 129, 1)", "rgba(239, 68, 68, 1)"],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: T.tableHeaders.Calories + " (kcal)" }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function initializeTrendChart() {
            const ctx = document.getElementById("trendChart").getContext("2d");
            trendChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [], // Dagar
                    datasets: [{
                        label: 'Totala Kalorier',
                        data: [],
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2
                    },
                    {
                        label: 'Kalorim√•l',
                        data: [],
                        borderColor: 'rgba(239, 68, 68, 0.8)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Kalorier (kcal)' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        }

        function initializeActivityTrendChart() {
            const ctx = document.getElementById("activityTrendChart").getContext("2d");
            activityTrendChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [], // Dagar
                    datasets: [{
                        label: 'Tr√§ningsminuter',
                        data: [],
                        borderColor: 'rgba(245, 158, 11, 1)', // Activity Color
                        backgroundColor: 'rgba(245, 158, 11, 0.2)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2
                    },
                    {
                        label: 'M√•l (min)',
                        data: [],
                        borderColor: 'rgba(59, 130, 246, 0.8)',
                        backgroundColor: 'transparent',
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Minuter' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: { legend: { display: true } }
                }
            });
        }

        function initializeGoalStatusChart() {
            const ctx = document.getElementById("goalStatusChart").getContext("2d");
            goalStatusChart = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Hydrering (ml)", "Aktivitet (min)", "Kalorier (kcal)"],
                    datasets: [
                        {
                            label: 'Uppn√•tt',
                            data: [0, 0, 0],
                            backgroundColor: ["rgba(59, 130, 246, 0.8)", "rgba(245, 158, 11, 0.8)", "rgba(16, 185, 129, 0.8)"],
                        },
                        {
                            label: 'M√•l',
                            data: [0, 0, 0],
                            backgroundColor: ["#e2e8f0", "#e2e8f0", "#e2e8f0"],
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // G√∂r det till ett horisontellt stapeldiagram
                    scales: {
                        x: {
                            stacked: true,
                            beginAtZero: true,
                            title: { display: true, text: 'V√§rde' }
                        },
                        y: {
                            stacked: true
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                // Visar faktiskt v√§rde ist√§llet f√∂r stapelns total
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    if (label === 'Uppn√•tt') {
                                        return `Uppn√•tt: ${context.parsed.x}`;
                                    } else if (label === 'M√•l') {
                                        const achieved = context.chart.data.datasets[0].data[context.dataIndex];
                                        const goal = achieved + context.parsed.x;
                                        return `√Öterst√•ende: ${context.parsed.x} (M√•l: ${goal})`;
                                    }
                                    return null;
                                }
                            }
                        }
                    }
                }
            });
        }

        function initializeMetricTrendChart() {
            const ctx = document.getElementById("metricTrendChart").getContext("2d");
            metricTrendChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [],
                    datasets: [{
                        label: 'V√§rde',
                        data: [],
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.2)',
                        fill: true,
                        tension: 0.3,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'M√§tv√§rde' }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }
        // --- SLUT DIAGRAM INITIALISERING ---


        // --- DATOHANTERING (LADDA & SPARA med localStorage) ---
        function loadData() {
            allMeals = JSON.parse(localStorage.getItem("liverDietMeals") || "[]");
            journalEntries = JSON.parse(localStorage.getItem("liverDietJournal") || "[]");
            healthMetrics = JSON.parse(localStorage.getItem("healthMetrics") || "[]"); // NYTT: Ladda M√§tv√§rden
            dietGoals = JSON.parse(localStorage.getItem("dietGoals") || "{}");
            waterGoal = parseInt(localStorage.getItem("waterGoal")) || 2500;
            waterIntake = JSON.parse(localStorage.getItem("waterIntake") || "{}");
            activityGoal = parseInt(localStorage.getItem("activityGoal")) || 30;
            activityMinutes = JSON.parse(localStorage.getItem("activityMinutes") || "{}");
            // Ladda in Custom Foods
            customFoodDatabase = JSON.parse(localStorage.getItem("customFoodDatabase") || "{}");
        }

        function saveData() {
            localStorage.setItem("liverDietMeals", JSON.stringify(allMeals));
            localStorage.setItem("liverDietJournal", JSON.stringify(journalEntries));
            localStorage.setItem("healthMetrics", JSON.stringify(healthMetrics)); // NYTT: Spara M√§tv√§rden
            localStorage.setItem("dietGoals", JSON.stringify(dietGoals));
            localStorage.setItem("waterGoal", waterGoal.toString());
            localStorage.setItem("waterIntake", JSON.stringify(waterIntake));
            localStorage.setItem("activityGoal", activityGoal.toString());
            localStorage.setItem("activityMinutes", JSON.stringify(activityMinutes));
            // Spara Custom Foods
            localStorage.setItem("customFoodDatabase", JSON.stringify(customFoodDatabase));
        }

        // Funktion f√∂r att spara m√•l
        function saveGoals() {
            dietGoals.calories = parseInt(document.getElementById('goalCalories').value) || 0;
            dietGoals.protein = parseInt(document.getElementById('goalProtein').value) || 0;
            dietGoals.fat = parseInt(document.getElementById('goalFat').value) || 0;
            dietGoals.carbs = parseInt(document.getElementById('goalCarbs').value) || 0;
            saveData();
            updateUI();

            // Visuell feedback
            const saveButton = document.querySelector('#overview .card:nth-child(1) button');
            const originalText = saveButton.innerHTML;
            saveButton.innerHTML = 'M√•l Sparade! ‚úÖ';
            setTimeout(() => { saveButton.innerHTML = originalText; }, 1500);
        }

        // --- CUSTOM FOOD HANTERING ---
        function addCustomFood() {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            const name = document.getElementById('customFoodName').value.trim();
            const protein = parseFloat(document.getElementById('customFoodProtein').value) || 0;
            const fat = parseFloat(document.getElementById('customFoodFat').value) || 0;
            const carbs = parseFloat(document.getElementById('customFoodCarbs').value) || 0;
            const calories = parseInt(document.getElementById('customFoodCalories').value) || 0;
            const liverFriendly = document.getElementById('customFoodFriendly').checked;

            if (name === "" || foodDatabase.hasOwnProperty(name)) {
                alert(T.prompts.invalidName);
                return;
            }

            customFoodDatabase[name] = { protein, fat, carbs, calories, liverFriendly };
            saveData();
            populateFoodSelect(); // Uppdatera rullistan

            // √Öterst√§ll formul√§ret
            document.getElementById('customFoodName').value = '';
            document.getElementById('customFoodProtein').value = '0';
            document.getElementById('customFoodFat').value = '0';
            document.getElementById('customFoodCarbs').value = '0';
            document.getElementById('customFoodCalories').value = '0';
            document.getElementById('customFoodFriendly').checked = true;

            alert(T.alerts.customFoodSuccess(name));
        }

        // --- M√ÖLTIDSHANTERING ---
        function addMeal() {
            const mealType = document.getElementById("mealType").value; // Detta √§r den svenska nyckeln
            const food = document.getElementById("foodSelect").value;

            const finalGramsInput = document.getElementById("finalGrams");
            const amount = parseInt(finalGramsInput.value);

            if (!amount || amount <= 0 || !document.getElementById("mealDate").value) {
                console.error("Valideringsfel: V√§nligen v√§lj ett livsmedel, ange en m√§ngd och ett datum.");
                return;
            }

            allMeals.push({ id: Date.now(), date: currentDate, mealType, food, amount });
            saveData();
            updateUI();
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); // Uppdatera kalenderprickar
            document.getElementById("amountValue").value = 1;
            // V√§ljer standardenheten "gram (g)" igen
            document.getElementById("amountUnit").value = Translations['sv'].units[0].value; // Anv√§nd svensk standardvikt
            calculateMealPreview();

            // NYTT: Scrolla till den nya raden
            setTimeout(() => {
                const table = document.getElementById('mealTableBody');
                if (table.lastChild) {
                    table.lastChild.scrollIntoView({ behavior: 'smooth', block: 'end' });
                }
            }, 100);
        }

        function deleteMeal(id) {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            allMeals = allMeals.filter(meal => meal.id !== id);
            saveData();
            updateUI();
            updateLiverHealthFeedback();
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth()); // Uppdatera kalenderprickar
        }

        // Funktion f√∂r att ber√§kna m√•ltidsf√∂rhandsgranskning (Uppdaterad f√∂r portionshantering)
        function calculateMealPreview() {
            const T = Translations[currentLang];
            const food = document.getElementById("foodSelect").value;
            const amountValue = parseFloat(document.getElementById("amountValue").value) || 0;
            const amountUnitGram = parseFloat(document.getElementById("amountUnit").value) || 100;

            // Ber√§kna slutgiltig vikt i gram
            const finalGrams = amountValue * amountUnitGram;
            document.getElementById("finalGrams").value = finalGrams.toFixed(0);

            const previewDiv = document.getElementById("mealPreview");
            const previewContent = document.getElementById("mealPreviewContent");

            if (!food || amountValue <= 0 || !foodDatabase[food]) {
                previewDiv.style.display = 'none';
                return;
            }

            const data = foodDatabase[food];
            const factor = finalGrams / 100;

            const protein = (data.protein * factor).toFixed(1);
            const fat = (data.fat * factor).toFixed(1);
            const carbs = (data.carbs * factor).toFixed(1);
            const calories = (data.calories * factor).toFixed(0);

            const friendlyText = data.liverFriendly
                ? `<span style="color: var(--green); font-weight: 600;">‚úÖ ${T.tableHeaders.LiverFriendly}</span>`
                : `<span style="color: var(--red); font-weight: 600;">‚ùå ${T.tableHeaders.LiverFriendly} (${T.tableHeaders.DeleteMeal})</span>`;

            previewContent.innerHTML = `
            ${friendlyText} | 
            ${T.tableHeaders.Protein}: <b>${protein}g</b> | 
            ${T.tableHeaders.Fat}: <b>${fat}g</b> | 
            ${T.tableHeaders.Carbs}: <b>${carbs}g</b> | 
            ${T.tableHeaders.Calories}: <b>${calories} ${T.tableHeaders.Calories.toLowerCase()}</b>
            <br><i>${T.h3CalculatedIntake} (${finalGrams.toFixed(0)} g).</i>
        `;
            previewDiv.style.display = 'block';
        }

        // NYTT: Lokal Leverh√§lsorapport (Ers√§tter AI-f√∂rslag)
        function updateLiverHealthFeedback() {
            const T = Translations[currentLang];
            const mealsForToday = allMeals.filter(meal => meal.date === currentDate);
            const feedbackElement = document.getElementById('liverHealthFeedback');

            const formattedDate = formatDate(currentDate).toLowerCase();

            if (mealsForToday.length === 0) {
                feedbackElement.innerHTML = `<h3>${T.feedback.welcome}</h3><p>${T.feedback.logFirstMeal(formattedDate)}</p>`;
                feedbackElement.style.background = '#e0f2fe';
                feedbackElement.style.border = '1px solid var(--primary-blue-dark)';
                feedbackElement.style.color = 'var(--text-dark)';
                return;
            }

            let totalCalories = 0;
            let nonFriendlyCalories = 0;
            let nonFriendlyItems = {};

            mealsForToday.forEach(meal => {
                const data = foodDatabase[meal.food];
                const factor = meal.amount / 100;
                const mealCalories = data.calories * factor;
                totalCalories += mealCalories;

                if (!data.liverFriendly) {
                    nonFriendlyCalories += mealCalories;
                    if (!nonFriendlyItems[meal.food]) nonFriendlyItems[meal.food] = 0;
                    nonFriendlyItems[meal.food] += mealCalories;
                }
            });

            const nonFriendlyPercentage = totalCalories > 0 ? (nonFriendlyCalories / totalCalories) * 100 : 0;
            const nonFriendlyList = Object.keys(nonFriendlyItems).map(foodKey =>
                // Anv√§nd √∂versatt namn h√§r
                `- ${T.foodNames[foodKey] || foodKey} (${nonFriendlyItems[foodKey].toFixed(0)} kcal)`
            ).join('<br>');

            let h3, message, bgColor, borderColor, textColor;

            if (nonFriendlyPercentage === 0) {
                h3 = T.feedback.excellent;
                message = T.feedback.excellentMessage;
                bgColor = '#f0fff4';
                borderColor = 'var(--green)';
                textColor = '#065f46';
            } else if (nonFriendlyPercentage < 10) {
                h3 = T.feedback.good;
                message = T.feedback.goodMessage(nonFriendlyPercentage.toFixed(1), nonFriendlyCalories.toFixed(0), nonFriendlyList);
                bgColor = '#fffdfa';
                borderColor = 'var(--yellow)';
                textColor = '#b45309';
            } else {
                h3 = T.feedback.warning;
                message = T.feedback.warningMessage(nonFriendlyPercentage.toFixed(1), nonFriendlyCalories.toFixed(0), nonFriendlyList);
                bgColor = '#fef2f2';
                borderColor = 'var(--deep-red)';
                textColor = 'var(--deep-red)';
            }

            feedbackElement.innerHTML = `<h3>${h3}</h3><p>${message}</p>`;
            feedbackElement.style.background = bgColor;
            feedbackElement.style.border = `1px solid ${borderColor}`;
            feedbackElement.style.color = textColor;
        }


        // --- HYDRERINGSHANTERING ---

        function setWaterGoal() {
            const newGoal = parseInt(document.getElementById('waterGoalInput').value);
            if (!isNaN(newGoal) && newGoal > 0) {
                waterGoal = newGoal;
                saveData();
                updateUI();
            } else {
                console.error("Ogiltigt vattenm√•l angivet.");
            }
        }

        function addWater(amount) {
            if (!waterIntake[currentDate]) {
                waterIntake[currentDate] = 0;
            }
            waterIntake[currentDate] = Math.max(0, waterIntake[currentDate] + amount); // Se till att det inte g√•r under noll
            saveData();
            updateUI();
        }

        function updateWaterDisplay() {
            const T = Translations[currentLang];
            const intakeToday = waterIntake[currentDate] || 0;

            const intakeDisplay = document.getElementById('waterIntakeDisplay');
            const goalDisplay = document.getElementById('waterGoalDisplay');
            const intakeText = document.getElementById('intakeTodayText');
            const goalText = document.getElementById('waterGoalText');
            const card = document.querySelector('#overview .card:nth-child(2)');

            if (intakeDisplay) intakeDisplay.textContent = `${intakeToday} ml`;
            if (goalDisplay) goalDisplay.textContent = `${waterGoal} ml`;

            // Uppdatera h3-texterna
            if (intakeText) intakeText.textContent = T.overview.intakeToday;
            if (goalText) goalText.textContent = T.overview.goal;

            if (card) {
                if (intakeToday >= waterGoal) {
                    card.style.border = `2px solid var(--green)`;
                } else {
                    card.style.border = `none`;
                }
            }
        }

        // --- AKTIVITETSHANTERING ---
        function setActivityGoal() {
            const newGoal = parseInt(document.getElementById('activityGoalInput').value);
            if (!isNaN(newGoal) && newGoal > 0) {
                activityGoal = newGoal;
                saveData();
                updateUI();
            } else {
                console.error("Ogiltigt aktivitetsm√•l angivet.");
            }
        }

        function addActivity(amount) {
            if (!activityMinutes[currentDate]) {
                activityMinutes[currentDate] = 0;
            }
            activityMinutes[currentDate] = Math.max(0, activityMinutes[currentDate] + amount); // Se till att det inte g√•r under noll
            saveData();
            updateUI();
        }

        function updateActivityDisplay() {
            const T = Translations[currentLang];
            const minutesToday = activityMinutes[currentDate] || 0;

            const minutesDisplay = document.getElementById('activityMinutesDisplay');
            const goalDisplay = document.getElementById('activityGoalDisplay');
            const trainingText = document.getElementById('trainingTodayText');
            const activityGoalText = document.getElementById('activityGoalText');
            const card = document.querySelector('#overview .card:nth-child(3)');

            if (minutesDisplay) minutesDisplay.textContent = `${minutesToday} min`;
            if (goalDisplay) goalDisplay.textContent = `${activityGoal} min`;

            // Uppdatera h3-texterna
            if (trainingText) trainingText.textContent = T.overview.trainingToday;
            if (activityGoalText) activityGoalText.textContent = T.overview.goal;

            if (card) {
                if (minutesToday >= activityGoal) {
                    card.style.border = `2px solid var(--green)`;
                } else {
                    card.style.border = `none`;
                }
            }
        }


        // --- JOURNALHANTERING ---
        function saveJournalEntry() {
            const journalTextarea = document.getElementById("journalText");
            const saveButton = document.getElementById("saveJournalButton");
            const moodInput = document.getElementById("journalMood");

            const originalText = saveButton.innerHTML;

            const text = journalTextarea.value;
            const mood = parseInt(moodInput.value);

            if (text.trim() === "") return;

            const timestampISO = new Date().toISOString();
            const timestampDisplay = new Date().toLocaleString(currentLang === 'sv' ? 'sv-SE' : 'en-US'); // Anv√§nd engelsk formatering f√∂r icke-svenska spr√•k tills vidare

            journalEntries.unshift({ id: Date.now(), timestamp: timestampISO, displayTime: timestampDisplay, text, mood });
            saveData();
            updateUI();
            journalTextarea.value = "";
            moodInput.value = "3"; // √Öterst√§ll
            document.getElementById("currentMoodValue").textContent = "3"; // √Öterst√§ll

            // Visuell feedback
            saveButton.innerHTML = 'Sparat! ‚úÖ';
            saveButton.disabled = true;
            setTimeout(() => {
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
            }, 1500);
        }

        function renderJournalEntries() {
            const T = Translations[currentLang];
            const container = document.getElementById("journal-entries");
            const filterMood = parseInt(document.getElementById("filterMood")?.value || 0);
            const filterText = document.getElementById("filterText")?.value.toLowerCase() || '';

            // Filtrera journalanteckningar
            let filteredEntries = journalEntries.filter(entry => {
                const moodMatch = (filterMood === 0) || (entry.mood === filterMood);
                const textMatch = (filterText.length === 0) || (entry.text.toLowerCase().includes(filterText));
                return moodMatch && textMatch;
            });

            container.innerHTML = "";

            if (filteredEntries.length === 0) {
                container.innerHTML = `<p>${filterText.length > 0 || filterMood !== 0 ? T.journal.noFilterMatch : T.journal.noEntriesYet}</p>`;
                return;
            }

            const moodEmojis = { 1: 'üòû', 2: 'üòê', 3: 'üôÇ', 4: 'üòÑ', 5: 'ü§©' };

            filteredEntries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'journal-entry';
                entryDiv.id = `journal-entry-${entry.id}`; // L√§gg till ID f√∂r scroll
                const displayTime = entry.displayTime || new Date(entry.timestamp).toLocaleString(currentLang === 'sv' ? 'sv-SE' : 'en-US'); // Anv√§nd korrekt lokalisering
                const moodDisplay = entry.mood ? ` <span style="font-size: 1.2rem; margin-left: 10px;">${moodEmojis[entry.mood] || ''}</span> (${T.journal.moodValue}: ${entry.mood}/5)` : '';

                // Lade till ID f√∂r analyssvar
                entryDiv.innerHTML = `<small>${displayTime}${moodDisplay}</small><p>${entry.text.replace(/\n/g, '<br>')}</p>`;
                container.appendChild(entryDiv);
            });
        }

        // --- NY FUNKTION: JOURNALV√ÑRDEN ---

        function saveHealthMetric() {
            const T = Translations[currentLang];
            const date = document.getElementById('metricDate').value;
            const name = document.getElementById('metricName').value.trim();
            const value = parseFloat(document.getElementById('metricValue').value);
            const unit = document.getElementById('metricUnit').value.trim();

            if (!date || name === "" || isNaN(value) || unit === "") {
                alert(T.prompts.metricValidation);
                return;
            }

            const newMetric = {
                id: Date.now(),
                date: date,
                name: name,
                value: value,
                unit: unit
            };

            healthMetrics.unshift(newMetric); // L√§gg till √∂verst
            saveData();
            renderMetrics();
            renderMetricChart(); // Uppdatera diagrammet

            // √Öterst√§ll formul√§r
            document.getElementById('metricName').value = '';
            document.getElementById('metricValue').value = '';
            // L√•t enheten vara kvar f√∂r snabb inmatning av samma typ
        }

        function deleteMetric(id) {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            healthMetrics = healthMetrics.filter(metric => metric.id !== id);
            saveData();
            renderMetrics();
            renderMetricChart(); // Uppdatera diagrammet
        }

        function renderMetrics() {
            const T = Translations[currentLang];
            const tableBody = document.getElementById('metricTableBody');
            tableBody.innerHTML = '';

            const deleteHeader = document.getElementById('metricDeleteHeader');
            if (deleteHeader) {
                deleteHeader.style.display = isLocked ? 'none' : 'table-cell';
            }

            if (healthMetrics.length === 0) {
                // Skapa responsivt 'Inget loggat'-meddelande
                const colspan = isLocked ? 4 : 5;
                tableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: var(--text-secondary);">${T.journal.noMetrics}</td></tr>`;
                return;
            }

            // Sortera efter datum (nyaste f√∂rst)
            healthMetrics.sort((a, b) => new Date(b.date) - new Date(a.date));

            healthMetrics.forEach(metric => {
                const deleteCell = isLocked ? '' : `<td><button class="btn-delete" onclick="deleteMetric(${metric.id})">üóëÔ∏è</button></td>`;

                // NY FIX: L√§gg till data-label attribut f√∂r mobilvisning
                const row = `<tr>
                <td data-label="Datum">${formatDate(metric.date)}</td>
                <td data-label="V√§rde">${metric.name}</td>
                <td data-label="Resultat" class="numeric-cell">${metric.value.toFixed(2)}</td>
                <td data-label="Enhet">${metric.unit}</td>
                ${deleteCell}
            </tr>`;
                tableBody.insertAdjacentHTML("beforeend", row);
            });
        }

        function renderMetricChart() {
            const metricNameInput = document.getElementById('metricName');
            const selectedMetric = metricNameInput ? metricNameInput.value.trim() : '';

            // Filtrera data f√∂r det valda v√§rdet och sortera efter datum (√§ldst f√∂rst)
            const filteredData = healthMetrics
                .filter(m => m.name.toLowerCase() === selectedMetric.toLowerCase())
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const labels = filteredData.map(m => formatDate(m.date));
            const values = filteredData.map(m => m.value);
            const unit = filteredData.length > 0 ? filteredData[0].unit : '';

            metricTrendChart.data.labels = labels;
            metricTrendChart.data.datasets[0].data = values;
            metricTrendChart.data.datasets[0].label = selectedMetric ? `${selectedMetric} (${unit})` : 'V√§rde';
            metricTrendChart.options.scales.y.title.text = `M√§tv√§rde (${unit})`;

            metricTrendChart.update();
        }


        // --- DATA EXPORT/IMPORT/RESET ---
        function exportData() {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            const data = {
                allMeals,
                journalEntries,
                healthMetrics, // NYTT: Inkludera i export
                dietGoals,
                waterGoal,
                waterIntake,
                activityGoal,
                activityMinutes,
                customFoodDatabase
            };
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `leverkost_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Kontrollera att filen har de f√∂rv√§ntade nycklarna
                    if (importedData.allMeals && importedData.journalEntries) {
                        if (confirm(T.prompts.confirmReplaceData)) {
                            allMeals = importedData.allMeals || [];
                            journalEntries = importedData.journalEntries || [];
                            healthMetrics = importedData.healthMetrics || []; // NYTT: Importera Journalv√§rden
                            dietGoals = importedData.dietGoals || {};
                            waterGoal = importedData.waterGoal || 2500;
                            waterIntake = importedData.waterIntake || {};
                            activityGoal = importedData.activityGoal || 30;
                            activityMinutes = importedData.activityMinutes || {};
                            customFoodDatabase = importedData.customFoodDatabase || {};
                            currentLang = importedData.currentLang || 'sv'; // √Öterst√§ll spr√•k om det fanns med i backup

                            saveData();
                            location.reload(); // Ladda om sidan f√∂r att uppdatera allt korrekt
                        }
                    } else {
                        alert(T.alerts.importError);
                    }
                } catch (error) {
                    alert(T.alerts.jsonError);
                    console.error("Importfel:", error);
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            const T = Translations[currentLang];
            // Kontrollera l√•s
            if (isLocked) { alert(T.alerts.locked); return; }

            if (confirm(T.prompts.confirmResetData)) {
                localStorage.clear();
                location.reload();
            }
        }


        // --- KALENDERHANTERING ---
        function renderCalendar(year, month) {
            const monthNamesLocale = {
                sv: ["Januari", "Februari", "Mars", "April", "Maj", "Juni", "Juli", "Augusti", "September", "Oktober", "November", "December"],
                en: ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                es: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"],
                it: ["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]
            };
            const dayNamesLocale = {
                sv: ["M√•n", "Tis", "Ons", "Tor", "Fre", "L√∂r", "S√∂n"],
                en: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
                es: ["Lun", "Mar", "Mi√©", "Jue", "Vie", "S√°b", "Dom"],
                it: ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"]
            };

            document.getElementById('currentMonthYear').textContent = `${monthNamesLocale[currentLang][month]} ${year}`;

            const calendarGrid = document.getElementById('calendarDays');
            // Rensa gamla dagar, beh√•ll bara veckodagsnamnen
            calendarGrid.querySelectorAll('.calendar-day:not(.calendar-day-name)').forEach(day => day.remove());

            // Uppdatera veckodagsnamnen
            const dayNameElements = calendarGrid.querySelectorAll('.calendar-day-name');
            dayNamesLocale[currentLang].forEach((name, index) => {
                // Veckan startar alltid p√• M√•n (index 0) i HTML-strukturen
                dayNameElements[index].textContent = name;
            });


            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startDay = firstDayOfMonth.getDay(); // S√∂n=0, M√•n=1, etc.
            if (startDay === 0) startDay = 7; // G√∂r S√∂ndag till 7:e dagen (f√∂r 1-7 vecka)

            // Hitta alla dagar med loggad mat i denna m√•nad
            const loggedDates = allMeals
                .filter(meal => meal.date.startsWith(`${year}-${String(month + 1).padStart(2, '0')}`))
                .map(meal => meal.date.split('-')[2]); // Extrahera bara dagen

            // L√§gg till tomma rutor f√∂r att starta p√• r√§tt veckodag (M√•ndag = 1)
            for (let i = 1; i < startDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day empty';
                calendarGrid.appendChild(emptyDay);
            }

            // L√§gg till dagarna i m√•naden
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                dayElement.dataset.date = dateStr;

                // Markera dagen som har loggad mat
                if (loggedDates.includes(String(day).padStart(2, '0'))) {
                    dayElement.classList.add('logged');
                }

                // Markera den aktuella valda dagen
                if (dateStr === currentDate) {
                    dayElement.classList.add('selected');
                }

                dayElement.onclick = () => selectDate(dateStr);
                calendarGrid.appendChild(dayElement);
            }
        }

        function changeMonth(step) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + step);
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
        }

        function selectDate(dateStr) {
            currentDate = dateStr;
            // Uppdatera det dolda input-f√§ltet och rita om kalendern och UI
            document.getElementById("mealDate").value = currentDate;
            renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            updateUI();
        }


        // --- AI/GEMINI KOD BORTTAGEN F√ñR STABILITET ---

        // NYTT: Funktion f√∂r att byta sida och uppdatera diagram
        function showPage(pageId) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll(".sidebar a").forEach(a => a.classList.remove("active"));
            document.querySelector(`.sidebar a[onclick="showPage('${pageId}')"]`).classList.add("active");

            // Tvinga diagram att ritas om n√§r √ñversikt visas
            if (pageId === 'overview') {
                // Anropa de funktioner som uppdaterar diagrammen
                updateTrendSummary();
                updateGoalStatusChart();
                updateActivityTrendSummary();
                // √Ñven diagram som anv√§nder T-v√§rden m√•ste uppdateras
                initializeChart();
                initializeLiverFriendlyChart();
            }

            // Tvinga m√§tv√§rden att ritas om n√§r Journal visas
            if (pageId === 'journal') {
                renderMetrics();
                renderMetricChart(); // Rita om journaldiagrammet
            }

            // Tvinga kalendern att ritas om n√§r M√•ltider visas
            if (pageId === 'meals') {
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            }
        }


        // --- UI-UPPDATERINGAR ---
        function updateUI() {
            // FIX: L√§gg till s√§kerhetskontroll f√∂r mealsTitleDate
            const mealsTitleDateElement = document.getElementById("mealsTitleDate");
            if (mealsTitleDateElement) {
                const formattedDate = formatDate(currentDate);
                mealsTitleDateElement.textContent = formattedDate;
            }

            renderMealTable();
            updateNutritionSummary();
            renderJournalEntries();
            renderMetrics(); // Rendera m√§tv√§rden
            updateTrendSummary();
            updateWaterDisplay();
            updateActivityDisplay();
            updateGoalStatusChart();
            updateActivityTrendSummary();
            updateLiverHealthFeedback();
            updateLockUI(); // Se till att l√•sstatus visas
        }

        function renderMealTable() {
            const mealTableBody = document.getElementById("mealTableBody");
            mealTableBody.innerHTML = "";

            const mealsForToday = allMeals.filter(meal => meal.date === currentDate);

            // Hitta rubriken f√∂r ta bort-kolumnen i m√•ltidstabellen
            const mealTable = document.querySelector('#meals table');
            const deleteHeader = mealTable ? mealTable.querySelector('thead th:last-child') : null;
            if (deleteHeader) {
                deleteHeader.style.display = isLocked ? 'none' : 'table-cell';
            }


            mealsForToday.forEach(meal => {
                const data = foodDatabase[meal.food];
                const factor = meal.amount / 100;
                const protein = (data.protein * factor).toFixed(1);
                const fat = (data.fat * factor).toFixed(1);
                const carbs = (data.carbs * factor).toFixed(1);
                const calories = (data.calories * factor).toFixed(1);

                const liverStatus = data.liverFriendly
                    ? `<span style="color: var(--green); font-weight: 600;">‚úÖ ${T.tableHeaders.LiverFriendly}</span>`
                    : `<span style="color: var(--red); font-weight: 600;">‚ùå ${T.tableHeaders.DeleteMeal}</span>`;

                const rowClass = data.liverFriendly ? '' : 'warning-row';

                const deleteCell = isLocked ? '' : `<td class="locked-feature-cell"><button class="btn-delete" onclick="deleteMeal(${meal.id})">üóëÔ∏è</button></td>`;

                // NY FIX: Anv√§nd T.foodNames f√∂r att √∂vers√§tta livsmedelsnamnet i tabellen
                const translatedFoodName = T.foodNames[meal.food] || meal.food;

                // NY FIX: L√§gg till data-label attribut f√∂r mobilvisning
                const row = `<tr class="${rowClass}">
                <td data-label="${T.tableHeaders.MealType}">${T.mealTypes[meal.mealType] || meal.mealType}</td> 
                <td data-label="${T.tableHeaders.FoodItem}">${translatedFoodName}</td>
                <td data-label="${T.tableHeaders.Amount}" class="numeric-cell">${meal.amount} g</td>
                <td data-label="${T.tableHeaders.Protein}" class="numeric-cell">${protein} g</td>
                <td data-label="${T.tableHeaders.Fat}" class="numeric-cell">${fat} g</td>
                <td data-label="${T.tableHeaders.Carbs}" class="numeric-cell">${carbs} g</td>
                <td data-label="${T.tableHeaders.Calories}" class="numeric-cell">${calories} kcal</td>
                <td data-label="${T.tableHeaders.LiverFriendly}">${liverStatus}</td>
                ${deleteCell}
            </tr>`;
                mealTableBody.insertAdjacentHTML("beforeend", row);
            });

            if (mealsForToday.length === 0) {
                // Ber√§kna colspan: 8 fasta + 1 om ol√•st
                const colspan = isLocked ? 8 : 9;
                mealTableBody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; color: var(--text-secondary);">Inga m√•ltider loggade f√∂r ${formatDate(currentDate).toLowerCase()}.</td></tr>`;
            }

            // D√∂lj celler i tabellen om l√•st (efter att de renderats)
            document.querySelectorAll('#mealTableBody tr').forEach(row => {
                if (isLocked) {
                    const lastCell = row.querySelector('td:last-child');
                    if (lastCell) lastCell.style.display = 'none';
                }
            });
        }

        function updateNutritionSummary() {
            let total = { protein: 0, fat: 0, carbs: 0, calories: 0 };
            let liverFriendlyCalories = 0;
            let nonLiverFriendlyCalories = 0;

            const mealsForToday = allMeals.filter(meal => meal.date === currentDate);

            mealsForToday.forEach(meal => {
                const data = foodDatabase[meal.food];
                const factor = meal.amount / 100;
                const mealCalories = data.calories * factor;

                total.protein += data.protein * factor;
                total.fat += data.fat * factor;
                total.carbs += data.carbs * factor;
                total.calories += mealCalories;

                if (data.liverFriendly) {
                    liverFriendlyCalories += mealCalories;
                } else {
                    nonLiverFriendlyCalories += mealCalories;
                }
            });

            document.getElementById("totalProtein").textContent = `${total.protein.toFixed(1)} g` + (dietGoals.protein ? ` / ${dietGoals.protein} g` : '');
            document.getElementById("totalFat").textContent = `${total.fat.toFixed(1)} g` + (dietGoals.fat ? ` / ${dietGoals.fat} g` : '');
            document.getElementById("totalCarbs").textContent = `${total.carbs.toFixed(1)} g` + (dietGoals.carbs ? ` / ${dietGoals.carbs} g` : '');
            document.getElementById("totalCalories").textContent = `${total.calories.toFixed(0)} kcal` + (dietGoals.calories ? ` / ${dietGoals.calories} kcal` : '');


            const proteinCalories = total.protein * 4;
            const fatCalories = total.fat * 9;
            const carbsCalories = total.carbs * 4;

            // Uppdatera befintliga diagram med nya titlar/labels
            if (nutritionChart) {
                nutritionChart.data.labels = [T.tableHeaders.Protein + " (kcal)", T.tableHeaders.Fat + " (kcal)", T.tableHeaders.Carbs + " (kcal)"];
                nutritionChart.data.datasets[0].data = [proteinCalories, fatCalories, carbsCalories];
                nutritionChart.update();
            }

            if (liverFriendlyChart) {
                liverFriendlyChart.data.labels = [T.tableHeaders.LiverFriendly + " (Ja)", T.tableHeaders.LiverFriendly + " (Nej)"];
                liverFriendlyChart.data.datasets[0].data = [liverFriendlyCalories.toFixed(0), nonLiverFriendlyCalories.toFixed(0)];
                liverFriendlyChart.options.scales.y.title.text = T.tableHeaders.Calories + " (kcal)";
                liverFriendlyChart.update();
            }
        }

        function updateTrendSummary() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const calorieData = {};
            const dates = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                calorieData[dateKey] = 0;
                dates.push(dateKey);
            }

            allMeals.forEach(meal => {
                if (calorieData.hasOwnProperty(meal.date)) {
                    const data = foodDatabase[meal.food];
                    const factor = meal.amount / 100;
                    calorieData[meal.date] += data.calories * factor;
                }
            });

            // Anv√§nd spr√•kberoende veckodagsnamn f√∂r diagram
            let locale = 'sv-SE';
            switch (currentLang) {
                case 'en': locale = 'en-US'; break;
                case 'es': locale = 'es-ES'; break;
                case 'it': locale = 'it-IT'; break;
            }

            const chartLabels = dates.map(dateStr => {
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString(locale, { weekday: 'short', day: 'numeric' });
            });
            const chartValues = dates.map(dateKey => calorieData[dateKey].toFixed(0));

            if (trendChart) {
                trendChart.data.labels = chartLabels;
                trendChart.data.datasets[0].data = chartValues;

                const calorieGoal = dietGoals.calories || 0;
                const goalData = chartLabels.map(() => calorieGoal);

                trendChart.data.datasets[1].data = goalData;
                trendChart.data.datasets[1].hidden = (calorieGoal === 0);

                trendChart.update();
            }
        }

        function updateActivityTrendSummary() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const activityData = {};
            const dates = [];

            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                const dateKey = date.toISOString().split('T')[0];
                activityData[dateKey] = activityMinutes[dateKey] || 0;
                dates.push(dateKey);
            }

            // Anv√§nd spr√•kberoende veckodagsnamn f√∂r diagram
            let locale = 'sv-SE';
            switch (currentLang) {
                case 'en': locale = 'en-US'; break;
                case 'es': locale = 'es-ES'; break;
                case 'it': locale = 'it-IT'; break;
            }

            const chartLabels = dates.map(dateStr => {
                const [year, month, day] = dateStr.split('-').map(Number);
                const date = new Date(year, month - 1, day);
                return date.toLocaleDateString(locale, { weekday: 'short', day: 'numeric' });
            });
            const chartValues = dates.map(dateKey => activityData[dateKey].toFixed(0));

            if (activityTrendChart) {
                activityTrendChart.data.labels = chartLabels;
                activityTrendChart.data.datasets[0].data = chartValues;

                const activityGoalValue = activityGoal || 0;
                const goalData = chartLabels.map(() => activityGoalValue);

                activityTrendChart.data.datasets[1].data = goalData;
                activityTrendChart.data.datasets[1].hidden = (activityGoalValue === 0);

                activityTrendChart.update();
            }
        }

        function updateGoalStatusChart() {
            const waterAchieved = waterIntake[currentDate] || 0;
            const activityAchieved = activityMinutes[currentDate] || 0;

            let totalCalories = 0;
            allMeals.filter(meal => meal.date === currentDate).forEach(meal => {
                const data = foodDatabase[meal.food];
                const factor = meal.amount / 100;
                totalCalories += data.calories * factor;
            });

            const goalData = [
                waterGoal,
                activityGoal,
                dietGoals.calories || 0
            ];

            const achievedData = [
                waterAchieved,
                activityAchieved,
                totalCalories
            ];

            const remainingData = achievedData.map((achieved, index) => {
                const goal = goalData[index];
                if (goal === 0) return 0;
                return Math.max(0, goal - achieved);
            });

            goalStatusChart.data.datasets[0].data = achievedData.map((a, i) => Math.min(a, goalData[i] || a));
            goalStatusChart.data.datasets[1].data = remainingData;

            goalStatusChart.update();
        }
    </script>
</body>

</html>